---
title: ç¬¬ä¸€ç¯‡ä¸‡å­—é•¿æ–‡ï¼šå›´ç»•é€æ˜ä»£ç†çš„åˆä¸€æ¬¡æ¢ç©¶
permalink: /something-about-v2ray-with-tproxy/
date: 2020-09-01 00:00
---
æ˜¯çš„ï¼Œä½ æ²¡æœ‰çœ‹é”™ï¼Œè¿˜æ˜¯è¿™ä¸ªä¸»é¢˜ã€‚æˆ‘ä¹Ÿæ²¡ä»€ä¹ˆåŠæ³•ï¼Œå› ä¸ºå®åœ¨æ˜¯ä¸å®Œç¾å•Šï¼æ¯”å¦‚ï¼š

* è…¾è®¯ä¼šè®®ã€QQ ç”µè¯ç­‰ç±»ä¼¼è½¯ä»¶æ–­æµ
* ç½‘æ˜“äº‘éŸ³ä¹æ–­æµ
* â€¦â€¦

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘è¾—è½¬åä¾§çš„æ€è€ƒï¼Œæ—¥å¤œä¸åœçš„å®éªŒï¼Œåœ¨æ ‘è“æ´¾å’Œ J1900 ä¹‹é—´åå¤æ¨ªè·³ï¼Œå®‰è£… OpenWrtï¼Œä½¿ç”¨ Redirect ä»£æ›¿ TProxyï¼Œæ›´æ¢ä¸åŒçš„ DNS æŸ¥è¯¢æ€è·¯ï¼Œè°ƒè¯• V2Ray é…ç½®ç­‰ç­‰ã€‚ç›´åˆ°ä»Šå¤©ï¼ˆçœŸå®æƒ…å†µæ˜¯å‡ å¤©å‰ï¼‰ï¼Œæˆ‘åˆé‡æ–°è£…å›äº†äº²åˆ‡çš„ Ubuntu 20.04ï¼Œè¶æœºè®°å½•ä¸€ä¸‹è¿‡ç¨‹ä»¥åŠä¸€äº›é›¶ç¢çš„æ€è€ƒã€‚

<!--more-->

> ä»…ä»¥æ­¤æ–‡ï¼Œä½œä¸ºå¤§åŠå¹´æ¥æ‰€å­¦çŸ¥è¯†ä¸äº²æ‰‹å®è·µä¹‹æ€»ç»“ã€‚

## 1. OpenWrt VS Ubuntuï¼Œå“ªä¸€ä¸ªæ›´å¥½ç”¨ï¼Ÿ

ä»è¡¨é¢ä¸Šæ¥è¯´ï¼Œä½œä¸ºè·¯ç”±å™¨ç³»ç»Ÿï¼ŒOpenWrt æ˜æ˜¾æ›´å ä¼˜åŠ¿ï¼Œç›¸å¯¹äºæ–‡æœ¬ç•Œé¢æ›´æ˜“æ¥å—çš„ç½‘é¡µåå°ï¼Œä»¥åŠä¸°å¯Œçš„ç”Ÿæ€ï¼Œä½¿å…¶å¹¿å—å¥½è¯„ã€‚ä½†å¦ä¸€æ–¹é¢ï¼Œä¹Ÿè®¸å®ƒä¹Ÿåªèƒ½ä½œä¸ºã€Œè·¯ç”±å™¨ç³»ç»Ÿã€äº†ï¼Œæˆ–è€…è¯´æ›´é€‚åˆåœ¨ä¸»è·¯ç”±ä¸Šé¢ä½¿ç”¨ï¼Œä½†å¯¹äºæ—è·¯ç”±å’Œ x86 å¹³å°ï¼Œåè€Œæœ‰ç‚¹é¸¡è‚‹äº†ï¼Œå†åŠ ä¸Šä¸ªäººè§‰å¾—æœ‰æ—¶å€™å‘½ä»¤è¡Œæ›´åŠ ç®€æ´å¥½ç”¨ï¼ŒåŒ…æ‹¬æˆ‘åœ¨ OpenWrt é…ç½® V2Ray æ—¶å€™éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ V2Ray-Coreï¼Œè€Œä¸æ˜¯ LuCI ç•Œé¢ä¸Šçš„é‚£ç§ã€‚åæ­£æˆ‘æ˜¯å„ç§ç”¨ä¸æƒ¯ï¼Œæ„Ÿè§‰å’Œæ™®é€šçš„ Linux å‘è¡Œç‰ˆå·®è·å¤ªå¤§ï¼Œè¿™å°±æ˜¯æˆ‘æ¢å› Ubuntu çš„åŸå› ã€‚

é‚£ä¸ºä»€ä¹ˆæˆ‘ä¹‹å‰è¿˜è¦é€‰æ‹©è£… OpenWrt å‘¢ï¼Ÿé‚£å°±æ˜¯å†…æ ¸ä¼˜åŒ–çš„åŸå› ã€‚è€ƒè™‘åˆ°å®ƒæ˜¯ä¸“é—¨é€‚é…è·¯ç”±å™¨çš„ï¼Œæ‰€ä»¥åœ¨å†…æ ¸çš„ç½‘ç»œä¼˜åŒ–ä¸Šæˆ–è®¸å’Œæ™®é€šç³»ç»Ÿæœ‰äº›è®¸ä¸åŒï¼Œå®é™…ä½“éªŒä¸­ä¹Ÿèƒ½æ„Ÿå—åˆ°ä¸€äº›æå‡ã€‚ä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰æ˜ç¡®çš„è¯æ®ï¼Œç½‘ä¸Šä¹Ÿæ‰¾ä¸åˆ°éå¸¸æœ‰åŠ›çš„è¯´æ³•ï¼Œè‡ªå·±æ°´å¹³ä¸å¤Ÿï¼Œçœ‹ä¸æ‡‚å„ç§å‚æ•°ã€æºç ï¼Œæ‰€ä»¥ç»¼åˆè€ƒè™‘åï¼Œè¿˜æ˜¯æ¢äº†å›å»ã€‚

## 2. DNS æœåŠ¡å™¨çš„é€‰æ‹©

DNSï¼Œå³ **D**omain **N**ame **S**ystem æ˜¯å½“ä»Šäº’è”ç½‘çš„åŸºç¡€ï¼ŒDNS æœåŠ¡å™¨çš„æ­£ç¡®é…ç½®ååˆ†é‡è¦ï¼Œè½»åˆ™æ‹–æ…¢ä¸Šç½‘é€Ÿåº¦ï¼Œé‡åˆ™å¯¼è‡´æ— æ³•æ­£å¸¸è®¿é—®ç½‘ç»œã€‚

### å±€åŸŸç½‘ DNS æœåŠ¡å™¨çš„é€‰æ‹©

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘é€‰æ‹©äº†ç›‘å¬ 53 ç«¯å£ï¼Œä½¿ç”¨ Telescope DNS ä½œä¸ºæœåŠ¡å™¨ã€‚ä¸è¿‡å¦‚æœçœ‹è¿‡ç™½è¯æ–‡æ•™ç¨‹ä¸­çš„é…ç½®ï¼Œå°±ä¼šå‘ç°ï¼Œé‚£ç§æ€è·¯å’Œæˆ‘çš„æ€è·¯ä¸åŒã€‚è®¾[ç™½è¯æ–‡æ•™ç¨‹ä¸­çš„é…ç½®](https://guide.v2fly.org/app/tproxy.html)ä¸º A æ–¹å¼ï¼Œ[æˆ‘çš„é…ç½®](https://moecm.com/tproxy-with-v2ray-on-rpi)ä¸º B æ–¹å¼ï¼Œæˆ‘ä»¬æ¢è®¨ä¸€ä¸‹ä»–ä»¬çš„å¼‚åŒç‚¹ã€‚å®ƒä»¬çš„æµç¨‹çœ‹èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä»”ç»†åˆ†æåå´è§‰å¾—éå¸¸æœ‰è¶£ã€‚

é¦–å…ˆæ˜¯ A æ–¹å¼ï¼Œå®ƒçš„æ€è·¯æ˜¯å°† DNS æŸ¥è¯¢çš„æµé‡ä¸å…¶ä»–æµé‡æ”¾åˆ°ä¸€èµ·ï¼Œç„¶åè¿›å…¥ V2Ray çš„è·¯ç”±æ¨¡å—ä¸­å°† DNS æŸ¥è¯¢æµé‡ï¼ˆ53 ç«¯å£çš„ UDP æµé‡ï¼‰åˆ†ç¦»å‡ºæ¥ï¼Œè½¬å‘ DNS å‡ºç«™åè®®ï¼Œç„¶åäº¤ç»™ V2Ray å†…ç½® DNS æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼Œæœ€åè¿”å›æŸ¥è¯¢ç»“æœã€‚è€Œ B æ–¹å¼çš„æ€è·¯æ˜¯é€šè¿‡å¤–éƒ¨ç¨‹åºï¼ˆç›¸å¯¹äº V2Ray é€æ˜ä»£ç†çš„å¤–éƒ¨ï¼‰å¼€æ”¾ 53 ç«¯å£å»ºç«‹ DNS æœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ã€‚

è¿™å°±æ˜¯ä¸ºä½•åœ¨ A æ–¹å¼ iptables çš„é…ç½®ä¸­æœ‰ `-d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN` çš„æŒ‡ä»¤ã€‚ã€ŒRETURNã€ åœ¨è¿™é‡Œçš„æ„æ€å°±æ˜¯ç›´è¿åˆ°æ—è·¯ç”±å¹¶è½¬å‘åˆ°ä¸»è·¯ç”±ï¼Œè€Œä¸ç»è¿‡ V2Ray è¿›è¡Œé€æ˜ä»£ç†ï¼›ã€Œ-dã€åé¢åŠ çš„æ˜¯å±€åŸŸç½‘ IPï¼Œå¦‚æœåˆ°æ­¤ä¸ºæ­¢çš„è¯å…¶å®åŠŸèƒ½åŸºæœ¬æ­£å¸¸ï¼Œå‰ææ˜¯å°†å®¢æˆ·ç«¯çš„ DNS æœåŠ¡å™¨åœ°å€è®¾ä¸ºå±€åŸŸç½‘åœ°å€ä»¥å¤–çš„ IP åœ°å€ï¼ŒåŸå› å°±åœ¨äº DNS æŸ¥è¯¢æµé‡éœ€è¦å’Œå…¶ä»–æµé‡ä¸€èµ·è¿›å…¥ V2Rayï¼Œç„¶åå†è·¯ç”±æ¨¡å—ä¸­è¢«æŠ½å‡ºè¿›è¡ŒæŸ¥è¯¢ä»¥é¿å… DNS æ±¡æŸ“ï¼Œç„¶è€Œæ­¤æ—¶çš„ iptables è§„åˆ™å´å°† DNS æŸ¥è¯¢æµé‡ç›´æ¥å‘äº†å‡ºå»ï¼ˆå½“ç„¶æ˜¯åœ¨å®¢æˆ·ç«¯ DNS åœ°å€ä¸ºå±€åŸŸç½‘åœ°å€çš„æƒ…å†µä¸‹ï¼‰ï¼Œæ˜¾ç„¶è¾¾ä¸åˆ°ç›®çš„ï¼Œæ‰€ä»¥åŠ ä¸Šåé¢çš„ã€Œ-p udp ! --dport 53ã€ä¹Ÿå°±æ˜¯æ’é™¤ 53 ç«¯å£ UDP æµé‡ç›´è¿è§„åˆ™åï¼ŒDNS åŠ«æŒå¯ä»¥åšåˆ°åŸºæœ¬å®Œç¾äº†ã€‚è€Œè¿™ï¼Œå°±æ˜¯ A æ–¹å¼çš„æœ‰è¶£ç‚¹ã€‚

å…¶å®ï¼Œåœ¨ A æ–¹å¼ä¸ B æ–¹å¼ä¹‹é—´è¿˜å­˜åœ¨ç€å¦ä¸€ç§æ–¹æ¡ˆï¼Œå³ä½¿ç”¨ V2Ray å…¥ç«™ä»»æ„é—¨åè®®ç›‘å¬ 53 ç«¯å£æˆä¸º DNS æŸ¥è¯¢æœåŠ¡å™¨ã€‚è¿™ç§æ–¹å¼ä¸ B æ–¹å¼åŒæ ·ç›‘å¬ 53 ç«¯å£ï¼Œä½†ä¸éœ€è¦é¢å¤–çš„ç¨‹åºï¼Œä¸” DNS æŸ¥è¯¢æ–¹å¼ä¸ A æ–¹å¼ä¸€æ ·éƒ½æ˜¯é€šè¿‡ V2Ray è·¯ç”±è½¬å‘åˆ° DNS å‡ºç«™åè®®ï¼Œå¹¶è°ƒç”¨å†…ç½® DNS æœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ã€‚è¿™ç§æ–¹å¼çš„æœ‰è¶£ç‚¹ä¸»è¦åœ¨äºå…¥ç«™å’Œå‡ºç«™çš„ä¸¤ä¸ªåè®®ä¸Šã€‚

åœ¨è€ƒè™‘è¿™ä¸ªé—®é¢˜æ—¶ï¼Œæˆ‘æ›¾åœ¨ V2Ray çš„è®¨è®ºåŒºå‘è¿‡ä¸€ä¸ª [issue](https://github.com/v2ray/discussion/issues/751)ï¼Œæ­£æ˜¯å› ä¸ºåœ¨å…¶ä¸­å’Œä»–äººçš„äº¤æµï¼Œè®©æˆ‘ç»ˆäºé¢†æ‚Ÿäº†è¿™ä¸ªæ–¹æ¡ˆçš„åŸç†å’Œå¦™å¤„ã€‚

> Dokodemo doorï¼ˆä»»æ„é—¨ï¼‰æ˜¯ä¸€ä¸ªå…¥ç«™æ•°æ®åè®®ï¼Œå®ƒå¯ä»¥ç›‘å¬ä¸€ä¸ªæœ¬åœ°ç«¯å£ï¼Œå¹¶æŠŠæ‰€æœ‰è¿›å…¥æ­¤ç«¯å£çš„æ•°æ®å‘é€è‡³æŒ‡å®šæœåŠ¡å™¨çš„ä¸€ä¸ªç«¯å£ï¼Œä»è€Œè¾¾åˆ°ç«¯å£æ˜ å°„çš„æ•ˆæœã€‚[^1]
>
> ```json
> {
>  "address": "8.8.8.8",
>  "port": 53,
>  "network": "tcp",
>  "timeout": 0,
>  "followRedirect": false,
>  "userLevel": 0
> }
> ```

æŠ›å¼€ `network`ã€`timeout`ã€`userLevel` å‡ ä¸ªè¾ƒå®¹æ˜“ç†è§£çš„é…ç½®é¡¹ï¼Œæ¥è°ˆè°ˆ `followRedirect` å’Œ `address`ï¼ˆä»¥åŠ `port`ï¼‰ã€‚åœ¨é€æ˜ä»£ç†çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ Dokodemo-door æ¥å—æ•°æ®ï¼Œæµå…¥ V2Ray è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼Œé‚£æ—¶æˆ‘ä»¬å°† `followRedirect` è®¾ä¸º `true`ï¼ŒæŒ‰å­—é¢æ„æ€ç†è§£ï¼Œå°±æ˜¯å°†æ•°æ®åŒ…é‡å®šå‘è€Œä¸å˜æ¢åœ°å€ï¼Œæ­¤é€‰é¡¹å¿…é¡»ä¸é€æ˜ä»£ç†è”åŠ¨ï¼Œå¼€å¯æ—¶ `address` æ— æ•ˆã€‚è¿™æ ·çœ‹ä¸Šå»å¾ˆåˆç†ï¼Œç„¶è€Œåˆ°äº†åš DNS æœåŠ¡å™¨çš„æ—¶å€™ï¼Œä¸€åˆ‡éƒ½å˜äº†ã€‚æ­¤æ—¶å¿…é¡»æŒ‡å®šåœ°å€å’Œç«¯å£ï¼Œå¦åˆ™ä¼šå‡ºç°é”™è¯¯ã€‚æ‰€ä»¥è¿™ä¸ªåœ°æ–¹ï¼Œå¿…é¡»æŒ‡å®šä¸€ä¸ª DNS æœåŠ¡å™¨ï¼Œè€Œä¸”æ˜¯æ²¡æœ‰è¢«æ±¡æŸ“çš„å›½å¤– DNS æœåŠ¡å™¨ä¸ºä½³ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚

ä¹‹åæ ¹æ®è·¯ç”±çš„è®¾å®šï¼Œæµé‡ä¼šè¢«è½¬åˆ° DNS å‡ºç«™åè®®ã€‚

> DNS æ˜¯ä¸€ä¸ªå‡ºç«™åè®®ï¼Œä¸»è¦ç”¨äºæ‹¦æˆªå’Œè½¬å‘ DNS æŸ¥è¯¢ã€‚æ­¤å‡ºç«™åè®®åªèƒ½æ¥æ”¶ DNS æµé‡ï¼ˆåŒ…å«åŸºäº UDP å’Œ TCP åè®®çš„æŸ¥è¯¢ï¼‰ï¼Œå…¶å®ƒç±»å‹çš„æµé‡ä¼šå¯¼è‡´é”™è¯¯ã€‚[^2]
>
> **åœ¨å¤„ç† DNS æŸ¥è¯¢æ—¶ï¼Œæ­¤å‡ºç«™åè®®ä¼šå°† IP æŸ¥è¯¢ï¼ˆå³ A å’Œ AAAAï¼‰è½¬å‘ç»™å†…ç½®çš„ [DNS æœåŠ¡å™¨](https://www.v2fly.org/config/dns.html)ã€‚å…¶å®ƒç±»å‹çš„æŸ¥è¯¢æµé‡å°†è¢«è½¬å‘è‡³å®ƒä»¬åŸæœ¬çš„ç›®æ ‡åœ°å€ã€‚**
>
> ```json
> {
>     "network": "tcp",
>     "address": "1.1.1.1",
>     "port": 53
> }
> ```

åŠ ç²—çš„ä¸€å¥è¯é“å‡ºäº†æ­¤åè®®çš„æœ¬è´¨ï¼ŒDNS å‡ºç«™åè®®çš„ç‰¹ç‚¹å°±åœ¨äºä¸€ä¸ªè‡ªåŠ¨åŒ–ã€‚V2Ray å†…ç½®çš„ DNS æœåŠ¡å™¨åŠŸèƒ½ç®€å•ï¼Œåªæ”¯æŒ A/AAAA è®°å½•æŸ¥è¯¢ï¼Œæ‰€ä»¥æµé‡åœ¨è¢«å¯¼å‘ DNS å‡ºç«™åè®®åä¼šè¿›è¡Œè‡ªåŠ¨è¿‡æ»¤ï¼Œé¦–å…ˆä¸ºé˜²æ­¢å¯¼å…¥é”™è¯¯æµé‡ï¼Œå…ˆæŠŠä¸æ˜¯ DNS æŸ¥è¯¢çš„æµé‡è¿‡æ»¤å‡ºå»ï¼Œä¹‹ååªå°†èƒ½æŸ¥è¯¢çš„ DNS æµé‡å¯¼å…¥å†…ç½® DNS æœåŠ¡å™¨ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå…¶ä»–æµé‡æ­£å¸¸å‡ºå»ã€‚ä¸è¿‡å‡ºå»åˆ°å“ªé‡Œå‘¢ï¼Ÿå½“ç„¶æ˜¯åœ¨ Dokodemo-door ä¸­é…ç½®å¥½çš„åœ°å€å’Œç«¯å£äº†ï¼Œæ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå»ºè®®é…ç½®æ— æ±¡æŸ“çš„ DNS æœåŠ¡å™¨ã€‚ä¸è¿‡ä½ ä¹Ÿå¯ä»¥åœ¨ DNS å‡ºç«™åè®®ä¸­é…ç½® DNS æœåŠ¡å™¨åœ°å€ï¼Œä½†æ˜¾ç„¶è¿™ç§äºŒæ¬¡é…ç½®æ²¡æœ‰å¤ªå¤§æ„ä¹‰ã€‚

åˆ°è¿™é‡Œå¥½åƒä¸€åˆ‡éƒ½ç»“æŸï¼Œç„¶è€Œè¿˜ä¸¤ä¸ªé—®é¢˜ä»å¾…è§£å†³ã€‚

1. åˆ†æµ

A/AAAA è®°å½•è¿›å…¥å†…ç½® DNS æœåŠ¡å™¨å¯ä»¥è¢«æ­£ç¡®çš„åˆ†æµè¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶è€Œç”±äº DNS åè®®æ˜¯å‡ºç«™åè®®ï¼Œæ— æ³•è¿›å…¥è·¯ç”±æ¨¡å—ï¼Œè€Œä¸”åªèƒ½é…ç½®ä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥å…¶ä½™çš„ DNS è®°å½•æ—¢æ— æ³•åšåˆ° DNS åˆ†æµï¼Œå‡ºç«™åä¹Ÿæ— æ³•èµ°ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«åŠ«æŒå¹¶æ±¡æŸ“ã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ä»£ç† DNS å‡ºç«™åè®®ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè‡³äºå¦‚ä½•åšåˆ° DNS åˆ†æµï¼Ÿå¯¹ä¸èµ·ï¼Œæ— æ³•åšåˆ°ï¼Œè¯·æ¢æ–¹æ¡ˆã€‚ğŸ˜

```json
{
    "protocol": "dns",
    "tag": "dns-out",
    "proxySettings": {
        "tag": "VMess æˆ–å…¶ä»–é€šå‘æœåŠ¡ç«¯çš„å‡ºç«™åè®®çš„æ ‡è¯†"
    }
}
```

<ol start="2"><li>UDP å»ºç«‹è¿æ¥æ—¶ç»‘å®šæºåœ°å€å¤±è´¥</li></ol>

è¿™ä¸ªé—®é¢˜çš„ä½“ç°åœ¨äºï¼Œå¦‚æœè®¾å¤‡ä¸ŠæŸä¸€ UDP ç«¯å£å·²è¢«ç›‘å¬ï¼Œæ— è®ºæ˜¯ V2Ray è¿˜æ˜¯å…¶ä»–è½¯ä»¶ç›‘å¬ï¼Œéƒ½ä¼šå¯¼è‡´é€æ˜ä»£ç†æ—¶è®¿é—®åŒä¸€ç«¯å£çš„ UDP æœåŠ¡æ—¶å‡ºé”™ï¼Œæ—¥å¿—ä¸­ä¼šå‡ºç° `failed to bind source address to [x x x x] > address already in use` å­—æ ·çš„é”™è¯¯ã€‚æ­¤é”™è¯¯å±äº V2Ray å†…éƒ¨é—®é¢˜ï¼Œæš‚æ—¶æ— è§£ï¼ˆé™¤éæ‚¨æ˜¯å¤§ä½¬ï¼‰ã€‚è¯¦æƒ…è¯·è§ï¼š[Report for ' failed to bind source address > address already in use' when using tproxy Â· Issue #68 Â· v2fly/v2ray-core](https://github.com/v2fly/v2ray-core/issues/68)ã€‚

ä»¥ä¸Šå¾ˆå¤šå†…å®¹å…¶å®éƒ½å¯ä»¥åœ¨[æ–°ç™½è¯æ–‡æ•™ç¨‹çš„ DNS æœåŠ¡å™¨ç¯‡](https://www.v2fly.org/config/dns.html)æ‰¾åˆ°ï¼Œæˆ‘ä¸è¿‡æ˜¯ç”¨æˆ‘è‡ªå·±çš„è¯­è¨€åŠ ä¸Šä¸€ç‚¹ç‚¹çš„ç†è§£å†™ä¸‹è¿™äº›æ–‡å­—ã€‚æœ€åæ”¾ä¸€å¼ è¡¨æ ¼ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚

| ç±»å‹               | ä¼˜ç‚¹                                                      | ç¼ºç‚¹                                                         |
| ------------------ | --------------------------------------------------------- | ------------------------------------------------------------ |
| V2Ray å†…éƒ¨åˆ†ç¦» DNS | æ— éœ€å…¶ä»–è½¯ä»¶ï¼›æ— éœ€ç›‘å¬ç«¯å£ï¼›å®¢æˆ·ç«¯ DNS æœåŠ¡å™¨åœ°å€å¯ä¸ºä»»æ„ | `dig` åŠç±»ä¼¼æŒ‡ä»¤æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼›å¯æ‰©å±•æ€§ä½ï¼›A/AAAA ä»¥å¤–çš„ DNS è®°å½•æ— æ³•åˆ†æµã€ç¼“å­˜ï¼›Netfilter é…ç½®ç•¥å¤æ‚ |
| V2Ray DNS æœåŠ¡å™¨   | æ— éœ€å…¶ä»–è½¯ä»¶                                              | å­˜åœ¨ UDP æ–¹é¢çš„ bugï¼›å¯æ‰©å±•æ€§ä½ï¼›A/AAAA ä»¥å¤–çš„ DNS è®°å½•æ— æ³•åˆ†æµã€ç¼“å­˜ï¼›V2Ray é…ç½®ç•¥å¤æ‚ |
| å¤–éƒ¨ DNS æœåŠ¡å™¨    | ç‹¬ç«‹äº V2Rayï¼Œå³ä½¿ V2Ray ä¸å¯ç”¨ä¹Ÿå¯æ­£å¸¸å·¥ä½œï¼›å¯æ‰©å±•æ€§é«˜   | éœ€è¦é¢å¤–è½¯ä»¶                                                 |

### å…¬ç½‘ DNS æœåŠ¡å™¨çš„é€‰æ‹©

å…¬å…± DNS æœåŠ¡å™¨çš„é€‰æ‹©å¾ˆå¤§ä¸€éƒ¨åˆ†å‚è€ƒäº†è‹å¡å¡çš„æ–‡ç« ï¼š[å¦‚ä½•é€‰æ‹©é€‚åˆçš„å…¬å…± DNSï¼Ÿ \[2020\] | Sukka's Blog](https://blog.skk.moe/post/which-public-dns-to-use/)ã€‚

å›½å†… DNS æœåŠ¡å™¨é€‰æ‹©æ–¹é¢æ¯”è¾ƒç®€å•ï¼Œé€Ÿåº¦å¿« + å¯é å³å¯ã€‚ä¸è¿‡è¿™ä¸ªã€Œå¿«ã€å°±è¦ä»ä¸¤æ–¹é¢æ¥è¯´äº†ï¼Œä¸€æ–¹é¢æ˜¯ DNS æŸ¥è¯¢é€Ÿåº¦ï¼Œè¿™ä¸ªé€Ÿåº¦å…¶å®å¯¹ä½“éªŒå½±å“ä¸åˆ°ï¼Œå› ä¸ºä¸è¿‡æ˜¯å‡ åæ¯«ç§’ï¼›ç¬¬äºŒæ–¹é¢åˆ™æ˜¯æŸ¥æ‰¾åˆ°çš„ IP ä¸ä½ æ‰€åœ¨åœ°åŸŸä»¥åŠè¿è¥å•†ä¹‹é—´çš„å…³ç³»ï¼Œå°ç½‘ç«™å• IP ç›´æ¥è¿æ¥è¿˜å¥½è¯´ï¼Œä½†å¦‚æœæœ‰ CDN å°±ä¸åŒäº†ã€‚ç†è®ºä¸Šï¼ŒISP ç»™ä½ åˆ†é…çš„ DNS æœåŠ¡å™¨å¯¹äº CDN æ˜¯æœ€å‹å¥½çš„ï¼Œè®¿é—®æ—¶ä¼šè¿æ¥åˆ°ä¸ä½ æœ€è¿‘çš„æœåŠ¡å™¨ï¼Œç„¶è€Œå£ç¢‘å®åœ¨å¤ªå·®ï¼Œå¤©å¤©å„ç§æ±¡æŸ“åŠ«æŒè°å—çš„äº†ï¼Ÿæ‰€ä»¥è‡ªç„¶é€‰æ‹©äº†å…¬å…± DNS æœåŠ¡å™¨ã€‚åæ¥å‡ºäº†ä¸€ç§åä¸º ECS çš„ä¸œè¥¿ï¼Œç®€å•æ¥è¯´å®ƒå¯ä»¥ç¼“è§£å‰é¢è¯´çš„é—®é¢˜ï¼Œç„¶è€Œè€ƒè™‘åˆ°éšç§ã€ECS çš„ç¼ºç‚¹[^3]ã€DNS æœåŠ¡å•†å¤ªæ‡’ä»¥åŠ**æˆ‘å¤ªæ‡’**ï¼Œçˆ±æ…¢å°±æ…¢å§ã€‚

å›½å¤– DNS æœåŠ¡å™¨åŒç†ï¼Œæƒ³è¦ CDN å‹å¥½çš„è¯ï¼Œè¦ä¹ˆ ECS è®¾ç½®ä¸º V2Ray æœåŠ¡ç«¯çš„ IPï¼Œè¦ä¹ˆè¿œç¨‹è§£æ DNSï¼Œå½“ç„¶ï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©æœ¬åœ°ç›´æ¥å‘èµ·è§£æè¯·æ±‚ã€‚é€‰æ‹©æ–¹é¢ï¼Œé™¤äº†ä¸Šé¢å›½å†… DNS æœåŠ¡å™¨é€‰æ‹©ä¸­è¯´çš„ä¸¤ç‚¹ï¼Œæ›´é‡è¦çš„æ˜¯**çº¯å‡€**ã€‚ä¸€æ˜¯æœåŠ¡å™¨æœ¬èº«çš„çº¯å‡€ï¼Œå›½å†…ä¸€ä¼— DNS æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬ä¸€å¼€å§‹æˆ‘è¯•ç”¨çš„çº¢é±¼ DNSï¼Œå³ä½¿åœ¨ä½¿ç”¨ DoHã€DoT è§£æçš„æƒ…å†µä¸‹å¾—åˆ°çš„ç»“æœä»æ˜¯æ±¡æŸ“çš„ï¼Œç”šè‡³å¾—ä¸åˆ°ç»“æœï¼Œæ‰€ä»¥è‡ªç„¶è¦é€‰æ‹©å›½å¤– DNS æœåŠ¡å™¨äº†ï¼›äºŒæ˜¯è§£æè¿‡ç¨‹ä¸­çš„çº¯å‡€ï¼Œç‰¢è®°ï¼šå³ä½¿å¾—ä¸åˆ°ä¹Ÿä¸è¦è¢«æ±¡æŸ“çš„ç»“æœï¼æ—¢ç„¶å†³å®šå³ä½¿æ˜¯ä»£ç†æŸ¥è¯¢æµé‡ä»¥è§„é¿æ±¡æŸ“çš„æ–¹æ³•ä¹Ÿä¸ä½¿ç”¨ï¼Œé‚£ä¹ˆä¼ ç»Ÿ UDP è§£æç›´æ¥æ’é™¤ï¼Œæ˜¯çš„ï¼Œä¸ºäº†ä¿è¯æ­£ç¡®çš„ç»“æœï¼Œå³ä½¿æ˜¯éæ ‡å‡† 53 ç«¯å£çš„æŸ¥è¯¢ä¹Ÿä¸å…è®¸ã€‚ä¹‹åå°±æ˜¯ TCP è§£æäº†ï¼Œç»è¿‡æµ‹è¯•ï¼Œåœ¨æˆ‘è¿™é‡Œï¼ŒGoogle çš„ `8.8.4.4` å’Œ OpenDNS çš„ `208.67.222.222` éƒ½å¯è¿é€šï¼Œä¸”æœ‰ä¸é”™çš„é€Ÿåº¦ï¼Œå°¤å…¶å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåè€…æ”¯æŒ `5353` å’Œ `443`ï¼ˆä¸æ˜¯ DoHï¼‰ç«¯å£çš„æŸ¥è¯¢ã€‚ä¸è¿‡è™½ç„¶ TCP ä¸ä¼šè¢«æ±¡æŸ“ï¼Œä½†æ˜¯ä¼šè¢«é‡ç½®è¿æ¥è€Œæ— æ³•å¾—åˆ°ç»“æœï¼Œæ‰€ä»¥ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘åˆæ·»åŠ äº† Showfom å¤§ä½¬çš„ DoHï¼š`https://doh.dns.sb/dns-query`ã€‚æ ¹æ® Telescope DNS çš„å¹¶å‘è¯·æ±‚åŠŸèƒ½å’Œæ•…éšœè½¬ç§»æœºåˆ¶ï¼Œå¯ä»¥ç›¸å¯¹å¿«é€Ÿçš„å¾—åˆ°æœ‰æ•ˆçš„è¿”å›ç»“æœã€‚

æœåŠ¡å™¨é€‰å¥½äº†ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯åˆ†æµã€‚ä»¥å¤–çš„æ–¹æ¡ˆéƒ½æ˜¯æŒ‰åŸŸååˆ†æµï¼Œç­›é€‰å›½å†…åŸŸåä½¿ç”¨å›½å†… DNS æœåŠ¡å™¨è§£æï¼Œå…¶ä½™åŸŸåä½¿ç”¨å›½å¤– DNS æœåŠ¡å™¨è§£æã€‚ç„¶è€Œè¿™æ ·åšçš„ç¼ºç‚¹å¾ˆå¤šï¼Œé¦–å…ˆå°±æ˜¯éœ€è¦ç»´æŠ¤ä¸€ä¸ªåŸŸååˆ—è¡¨ï¼Œè€ŒåŸŸåèƒŒåæŒ‡å‘çš„ IP å´ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œæ‰€ä»¥éœ€è¦ç»å¸¸æ›´æ–°ï¼›å…¶æ¬¡åŸŸåçš„åœ°åŸŸæ€§è¾ƒä½ï¼Œå›½å†…åŸŸåå¯èƒ½ä½¿ç”¨çš„æ˜¯å›½å¤–æœåŠ¡å™¨ï¼Œè€Œå›½å¤–åŸŸåå¯èƒ½é€šè¿‡ GeoIP è§£æåˆ°å›½å†…åœ°å€ï¼Œå†åŠ ä¸Š CDN çš„å¹²æ‰°ï¼Œå…¶å®æ•ˆæœå¹¶ä¸ç†æƒ³ã€‚ä¹Ÿæ˜¯å› ä¸º Telescope DNS æœ¬èº«çš„è®¾è®¡å’Œä¸€ç¯‡ [issue](https://github.com/wolf-joe/ts-dns/issues/25) ä¸­çš„å¯å‘ï¼Œæœ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š

![å…¬ç½‘ DNS æœåŠ¡å™¨çš„æŸ¥è¯¢è¿‡ç¨‹](https://cdn.moecm.com/dns-resolution-on-internet.svg)

è¿™ä¸ªè¿‡ç¨‹ä¸è½¯ä»¶[åŸæœ¬è¿‡ç¨‹](https://github.com/wolf-joe/ts-dns/blob/master/README.md)ç›¸æ¯”ï¼Œç¼ºå°‘äº†å‘ GFWList æ¯”å¯¹çš„ç¯èŠ‚ã€‚æˆ‘è®¤ä¸ºï¼Œè¢«å¢™åŸŸåå¯èƒ½ä¼šç”±äº GFWList æœªåŒ…å«è€Œè¿”å›é”™è¯¯ç»“æœã€‚è™½ç„¶æ¯”å¯¹å¯ä»¥å‡å°‘å‘å›½å¤– DNS æœåŠ¡å™¨è¯·æ±‚çš„æ— ç”¨åŠŸå¹¶èŠ‚çœæ—¶é—´ï¼Œä½†ä¸å…¶èŠ‚çœå‡ ç™¾æ¯«ç§’ï¼Œä¸å¦‚è·å¾—æ›´å‡†ç¡®çš„ç»“æœã€‚

å¦å¤–ä»¥ IP åœ°åŸŸä¸º DNS è§£æåˆ†æµå¥½å¤„å°±åœ¨äºå…¶åœ°ç†ä½ç½®åŸºæœ¬ä¸å˜ï¼Œå¯ä»¥è§„é¿åŸŸååˆ†æµçš„å¼Šç«¯ã€‚è¿™ç§æ–¹æ³•çš„å‰ææ˜¯è¢«æ±¡æŸ“çš„åŸŸåè¿”å›çš„ç»“æœä¸€å®šæ˜¯éä¸­å›½ IPï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•æ‰èƒ½æˆåŠŸã€‚

æœ€ååˆ†åˆ«æ˜¯ Telescope DNS ä¸‰ä¸ªæ–‡ä»¶ `ts-dns.toml`ã€`gfwlist.txt`ã€`cnip.txt` çš„å†™æ³•ã€‚

```toml
# Telescope DNS Configure File
# https://github.com/wolf-joe/ts-dns

listen = ":53"
gfwlist = "gfwlist.txt"
gfwlist_b64 = false # ä¸ä½¿ç”¨ base64 è§£ç  gfwlist.txt æ–‡ä»¶ä»¥è¿›è¡Œè‡ªå®šä¹‰ï¼ˆå…¨éƒ¨åŒ¹é…ï¼‰
cnip = "cnip.txt"
disable_ipv6 = true

hosts_files = ["/etc/hosts"]
[hosts]
"doh.dns.sb" = "104.27.159.178" # æ­¤åŸŸåå¯è‡ªè¡ŒæŸ¥è¯¢å¹¶ ping IP è¿›è¡Œä¿®æ”¹ä»¥å¾—åˆ°æœ€å¿«çš„æŸ¥è¯¢é€Ÿåº¦
"V2Ray æœåŠ¡ç«¯åŸŸå" = "V2Ray æœåŠ¡ç«¯ IP"

[query_log]
file = ""
ignore_cache = true
ignore_hosts = true

[cache]
size = 4096
min_ttl = 60
max_ttl = 86400

[groups]
  [groups.clean]
  no_cookie = true # ç¦ç”¨ edns cookieï¼Œ119.29.29.29 éœ€è¦è®¾ç½®ä¸ºtrue
  dns = ["119.29.29.29", "223.5.5.5"]
  concurrent = true

  [groups.dirty]
  dns = ["8.8.4.4/tcp", "208.67.222.222:443/tcp"]
  doh = ["https://doh.dns.sb/dns-query"]
  concurrent = true
```

```
||*
```

è‡³äºæœ€åä¸€ä¸ª `cnip.txt` æ–‡ä»¶è‡ªå¸¦ï¼Œæ‰€ä»¥æ— éœ€é…ç½®ï¼Œä¸è¿‡å¯ä»¥å®šæœŸé€šè¿‡ä»¥ä¸‹æŒ‡ä»¤ç”Ÿæˆæœ€æ–°åˆ—è¡¨ï¼š[^4]

```shell
$ wget -c http://ftp.apnic.net/stats/apnic/delegated-apnic-latest
$ cat delegated-apnic-latest | awk -F '|' '/CN/&&/ipv4/ {print $4 "/" 32-log($5)/log(2)}' > cnip.txt
```

## 3. Sniffing æµé‡æ¢æµ‹

æµé‡æ¢æµ‹ï¼Œå¯ä»¥æ¢æµ‹æµé‡ä¸­çš„æŸäº›ä¿¡æ¯ï¼Œè¿˜å¯ä»¥æŒ‰ç›®æ ‡åœ°å€é‡ç½®å½“å‰è¿æ¥çš„ç›®æ ‡ã€‚[^5]

è¿™æ ·è¯´èµ·æ¥ä¸å®¹æ˜“æ˜ç™½ï¼Œä¸è¿‡å®ƒçš„ç”¨é€”ååˆ†æ˜ç¡®ï¼š

1. æ¢æµ‹ BT æµé‡
2. æ¢æµ‹è¿æ¥çš„ç›®æ ‡åŸŸå
3. è§£å†³ DNS æ±¡æŸ“

é¦–å…ˆæ˜¯ç¬¬ä¸€æ¡ï¼Œè¿™ä¸ªè§„åˆ™é€‚åˆæ”¾åœ¨æœåŠ¡ç«¯ä¸Šï¼ˆå®¢æˆ·ç«¯äº¦å¯ï¼Œè§†å…·ä½“æƒ…å†µè€Œå®šï¼‰ï¼Œå› ä¸ºå¾ˆå¤šåœ°åŒºå¯¹è¿™æ–¹é¢æœ‰ä¸¥æ ¼çš„æ³•å¾‹è§„å®šï¼Œé€šè¿‡ Sniffing å°† BT æµé‡æ¢æµ‹å‡ºæ¥ï¼Œå¹¶åœ¨è·¯ç”±æ¨¡å—ä¸­è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥é¿å…è¿åæ³•å¾‹çš„é—®é¢˜ã€‚

å…¶æ¬¡æ˜¯ç¬¬äºŒæ¡ï¼Œç”±äºé€æ˜ä»£ç†ä¸­å®¢æˆ·ç«¯ä¼šé¦–å…ˆå°†åŸŸåè§£ææˆ IP å†å‘ç»™é€æ˜ä»£ç†æ‰€åœ¨æœºå™¨ä¸Šï¼Œè¿›å…¥åˆ° V2Ray ä¹‹å†…ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´è·¯ç”±æ¨¡å—ä¸­æ— æ³•é€šè¿‡åŸŸåå¯¹æµé‡è¿›è¡Œåˆ†æµã€‚å¼€å¯äº†æ¢æµ‹ä¹‹åå°±ä¼šå°† IP æŒ‡å‘çš„ç›®æ ‡åŸŸåæ¢æµ‹å‡ºæ¥ï¼Œç”¨äºåˆ†æµã€‚

æœ€åæ˜¯ç¬¬ä¸‰æ¡ï¼Œè¿™ä¸€æ¡å¯¹åº”çš„ã€Œé‡ç½®ã€è¿™ä¸€åŠŸèƒ½ã€‚å¼€å¯åå®ƒä¼šå°†åŸŸåè€Œä¸æ˜¯ IP å‘å‘æœåŠ¡ç«¯ï¼ˆæˆ‘æ²¡æœ‰è¯æ®ï¼‰ï¼Œè§„é¿äº† DNS æ±¡æŸ“çš„é—®é¢˜ï¼Œä¸è¿‡è¿™æ ·çš„è¯ï¼Œå‰é¢çš„ DNS åˆ†æµå²‚ä¸æ˜¯åšæ— ç”¨åŠŸäº†ï¼Ÿçš„ç¡®ï¼Œåœ¨ç™½è¯æ–‡ Redirect æ–¹å¼é€æ˜ä»£ç†çš„é‚£ç¯‡æ•™ç¨‹ä¸­ä½¿ç”¨äº†è¿™æ ·çš„æ–¹æ³•ï¼Œåœ¨æ–‡ç« çš„æœ€åè¿˜æåˆ°è¿™ç§æ–¹å¼å› ä¸ºä¼šé¢‘ç¹çš„å‘å›½å†… DNS æœåŠ¡å•†è¯·æ±‚è¢«æ±¡æŸ“çš„åŸŸåè€Œå­˜åœ¨éšç§é—®é¢˜ã€‚äº‹å®ä¸Šç›®å‰æˆ‘ä»¬ä½¿ç”¨çš„ DNS åˆ†æµæ–¹æ¡ˆåŒæ ·å­˜åœ¨è¿™ä¸€é—®é¢˜ï¼Œä¸è¿‡ä¸ºäº†è‰¯å¥½çš„ä½“éªŒè¿˜æ˜¯åšå‡ºäº†ä¸€å®šçš„å¦¥åã€‚åˆ©ç”¨ V2Ray æµé‡æ¢æµ‹å¹¶é‡ç½®è¿æ¥æ¥è§£å†³ DNS æ±¡æŸ“çš„æ–¹å¼æ—¢å¯ä»¥ä½œä¸ºå‰æ–‡æåˆ°çš„ä¸‰ç§å†…ç½‘ DNS æœåŠ¡å™¨çš„è¡¥å……ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹ä½œä¸ºä¸€ç§ DNS æ±¡æŸ“çš„è§£å†³æ–¹æ¡ˆã€‚å®è¯è¯´ï¼Œè™½ç„¶è¿™ç§æ–¹å¼å­˜åœ¨ç€ä¸€å®šçš„ä¸å¯æ§æ€§ï¼Œä½†åœ¨å®é™…ä½¿ç”¨ä¸­æš‚æ—¶æ²¡å‘ç°å¤ªå¤§é—®é¢˜ã€‚æ‰€ä»¥è‹¥é—®æˆ‘ç©¶ç«Ÿåº”è¯¥é€‰æ‹©ä½•ç§æ–¹å¼å»è§£å†³ DNS æ±¡æŸ“çš„é—®é¢˜ï¼Œæˆ‘ä¹Ÿåªèƒ½è¯´å„æœ‰åˆ©å¼Šï¼Œç•™å¾…æ›´å¤šæµ‹è¯•å’Œä½“éªŒã€‚

## 4. é€æ˜ä»£ç†ï¼šRedirect VS TProxyï¼Ÿiptables VS nftablesï¼Ÿ

æ‰€è°“é€æ˜ä»£ç†æŒ‡çš„å°±æ˜¯åœ¨å®¢æˆ·ç«¯ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å¯¹æµé‡è¿›è¡Œä»£ç†ï¼Œè¿ç”¨è¿™ç§æ–¹å¼å¯ä»¥å®ç°æ— æ„Ÿç¿»å¢™ã€‚

### Redirect (Redirect + TProxy) VS TProxy (çº¯ TProxy)

ä¸¤ç§éƒ½æ˜¯ç”¨æ¥å®ç°é€æ˜ä»£ç†çš„æ–¹å¼ï¼ŒåŒºåˆ«åœ¨äº Redirect æ— æ³•åœ¨ UDP å’Œ IPv6 ä¸­ä½¿ç”¨ï¼ŒTProxy åˆ™æ— æ­¤é™åˆ¶ã€‚[Linux å†…æ ¸æ–‡æ¡£](https://www.kernel.org/doc/Documentation/networking/tproxy.txt)ä¸­æŒ‡å‡ºäº† Redirect åœ¨ UDP ä¸­ä¸å¯è¡Œï¼Œä¸è¿‡æœ‰[è§‚ç‚¹](https://www.jianshu.com/p/76cea3ef249d)è®¤ä¸ºè¿™å¹¶ä¸æ˜¯æŠ€æœ¯ä¸Šçš„ä¸å¯è¡Œï¼Œè€Œæ˜¯äººä¸ºè®¾å®šã€‚

ä¸è¿‡è¿™é‡Œå°±ä¸è®¨è®ºè¿‡å¤šç†è®ºæ–¹é¢çš„é—®é¢˜äº†ï¼Œå› ä¸ºæˆ‘å¹¶ä¸äº†è§£è¿™æ–¹é¢çš„çŸ¥è¯†ã€‚æˆ–è®¸ä¸æ˜¯æ¯ä¸ªäººéƒ½æ˜ç™½æœ‰å…³ç”µçš„åŸç†ï¼Œä½†æ˜ç™½æŒ‰ä¸‹å¼€å…³å¯ä»¥æ‰“å¼€ç¯å°±è¶³å¤Ÿäº†ã€‚

> ä¸è¿‡æˆ‘å¯¹æ­¤çš„ç†è§£å°±æ˜¯å½“å‰æ–¹æ¡ˆæ˜¯æœ€é€‚åˆå†…æ ¸ç»“æ„çš„ï¼Œä¹Ÿæ˜¯å¼€é”€æœ€å°çš„ï¼Œä¹Ÿå°±æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦å»å®ç° Redirect é€æ˜ä»£ç† UDPã€‚

è™½ç„¶çœ‹ä¸Šå» TProxy åœ¨å„æ–¹é¢éƒ½ä¸é”™ï¼Œä½†åœ¨ OpenWrt ä¸Šè¿›è¡Œé€æ˜ä»£ç†æ—¶å‘ç°åœ¨ä½¿ç”¨ä¼šè®®è½¯ä»¶æ—¶ï¼ŒRedirect æ–¹æ¡ˆçš„æ–­æµæƒ…å†µä¸ TProxy æ–¹æ¡ˆç›¸æ¯”æœ‰å‡å°‘ã€‚

ä¸è¿‡æˆ‘è¿˜æ˜¯é€‰æ‹©äº† TProxyï¼Œä¹Ÿè®¸æ˜¯å¼ºè¿«ç—‡å¿ƒç†å§ï¼Ÿ

### iptables VS nftables

> Netfilterï¼Œåœ¨ Linux å†…æ ¸ä¸­çš„ä¸€ä¸ªè½¯ä»¶æ¡†æ¶ï¼Œç”¨äºç®¡ç†ç½‘ç»œæ•°æ®åŒ…ã€‚ä¸ä»…å…·æœ‰ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNATï¼‰çš„åŠŸèƒ½ï¼Œä¹Ÿå…·å¤‡æ•°æ®åŒ…å†…å®¹ä¿®æ”¹ã€ä»¥åŠæ•°æ®åŒ…è¿‡æ»¤ç­‰é˜²ç«å¢™åŠŸèƒ½ã€‚[^6]

è€Œ iptables å’Œ nftables å°±æ˜¯ç”¨æ¥æ§åˆ¶ Netfilter çš„ã€‚


ç›¸è¾ƒè€Œè¨€ï¼Œå¤§å®¶å¯èƒ½å¯¹ iptables æ›´ç†Ÿæ‚‰ã€‚æ–°ç‰ˆçš„ Debianã€RedHat ç­‰ Linux å‘è¡Œç‰ˆå·²ç»å°† nftables ä½œä¸ºé»˜è®¤çš„é˜²ç«å¢™å·¥å…·ï¼Œ[^7]ä½†å°±ç›®å‰æƒ…å†µè€Œè¨€ iptables è²Œä¼¼è¿˜æ˜¯ä¸»æµé€‰æ‹©ã€‚ä¸è¿‡æˆ‘æŠ±ç€ nftables èƒ½æå‡æ€§èƒ½è§£å†³ä¼šè®®è½¯ä»¶æ–­æµçš„å¸Œæœ›ï¼Œå°è¯•äº†ä¸€ä¸‹ nftablesã€‚

### ç†æƒ³çš„å±€åŸŸç½‘æ‹“æ‰‘ç»“æ„

åœ¨ V2EX ä¸Šï¼Œæˆ‘çœ‹åˆ°äº†è¿™æ ·çš„ä¸€ç¯‡å¸–å­ï¼š[å¯¹äºæ‰€è°“ã€Œæ—è·¯ç”±ã€çš„ç–‘æƒ‘ - V2EX](https://www.v2ex.com/t/663066)ã€‚

é‡Œé¢è¯´çš„ä»€ä¹ˆã€ŒåŠ¨æ€è·¯ç”±è¡¨ã€æˆ‘å¹¶ä¸æ˜¯ååˆ†äº†è§£ï¼Œä½†æ˜¯å…¶ä¸­çš„å¾ˆå¤šæ€è·¯å´è®©æˆ‘é™·å…¥æ²‰æ€ã€‚

ä»€ä¹ˆæ˜¯æ—è·¯ç”±ï¼Ÿå®ƒæ˜¯ç”¨æ¥å¤„ç†ä¸»è·¯ç”±ä¸é€‚åˆåšçš„äº‹æƒ…è€Œå‡ºç°çš„ã€‚æ¯”å¦‚è¯´ï¼ŒV2Ray çš„ VMess åè®®éœ€è¦åŠ è§£å¯†ï¼Œè€Œæ™®é€šè·¯ç”±å™¨çš„ CPU æ€§èƒ½ä¸€èˆ¬éƒ½å¾ˆå¼±ï¼Œè€Œä¸”å†…å­˜ã€ç£ç›˜ç©ºé—´éƒ½è¾ƒå°ï¼Œä¸é€‚åˆåšè¿™æ ·çš„å·¥ä½œã€‚è¿™æ—¶å€™è¿™ä¸€éƒ¨åˆ†äº¤ç»™æ—è·¯ç”±å»å¤„ç†ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åè¿‡æ¥è¯´ï¼Œå¦‚æœä¸»è·¯ç”±æ€§èƒ½ã€åŠŸèƒ½è¶³å¤Ÿå¼ºå¤§ï¼Œæ—è·¯ç”±å…¶å®å°±æ²¡æœ‰å¿…è¦å­˜åœ¨äº†ã€‚

ç„¶è€Œå®é™…æƒ…å†µå¾ˆæ®‹é…·ï¼Œé™¤éå°†è½¯è·¯ç”±ä½œä¸ºä¸»è·¯ç”±ï¼Œå¦åˆ™æ—è·¯ç”±è¿˜æ˜¯ååˆ†éœ€è¦çš„ã€‚åœ¨ç›®å‰å¤§éƒ¨åˆ†çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ‰‹åŠ¨æˆ–æ”¹å˜ DHCP é…ç½®å°†ç½‘å…³æ”¹ä¸ºæ—è·¯ç”±ç½‘å…³ï¼Œçœ‹å®Œäº†é‚£ç¯‡å¸–å­åæˆ‘åœ¨æƒ³ï¼Œæ˜¯å¦å¯ä»¥è€ƒè™‘å°† Netfilter é…ç½®æ”¾åœ¨ä¸»è·¯ç”±ä¸Šï¼ŒV2Rayã€DNS æœåŠ¡å™¨ç­‰å…¶ä»–æœåŠ¡æ”¾åœ¨æ—è·¯ç”±ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç›´è¿çš„æµé‡ä¸ç»è¿‡æ—è·¯ç”±ï¼Œç›´æ¥ä»ä¸»è·¯ç”±å‡ºå»ï¼Œæ›´åŠ å¿«é€Ÿã€‚è™½ç„¶æœ‰è¿™æ ·çš„æƒ³æ³•ï¼Œä½†æ˜¯å®¶é‡Œçš„è·¯ç”±å™¨å¥½åƒæ— æ³•åˆ·æœºï¼Œæ‰€ä»¥è¿™ä¸ªæƒ³æ³•è¿˜ç•™å¾…ä»¥åæ£€éªŒã€‚

> åœ¨å¼€å§‹å†™æ–‡ç« çš„ä¸ä¹…åï¼Œæˆ‘æƒŠå¥‡çš„å‘ç°ï¼Œå®¶é‡Œçš„ä¸»è·¯ç”±ï¼Œå°ç±³è·¯ç”±å™¨ 4 å¥½åƒå¯ä»¥åˆ·æœºï¼Œè€Œä¸”ä¸ç”¨æ‹†æœºå°±å¯ä»¥ç›´æ¥ç™»å½•ï¼Œæµ‹è¯•åå‘ç°æœçœŸå¦‚æ­¤ã€‚æ‰€ä»¥æ¥ä¸‹æ¥çš„åŠ¨æ‰‹æ–¹å‘å¯èƒ½å°±æ˜¯è¿™ä¸ªä¸»è·¯ç”±äº†ï¼ˆçœŸæ˜¯ä¸èƒ½é—²ç€å•Šâ€¦â€¦ï¼‰ã€‚

### å›´ç»• Netfilter çš„æ•°æ®æµå‘ä¸é…ç½®æŒ‡ä»¤ç®€æ

ç”±äºåœ¨[ä¹‹å‰çš„æ–‡ç« ](https://moecm.com/tproxy-with-v2ray-on-rpi)ä¸­å·²ç»è´´å‡ºäº†é…ç½®ï¼Œè¿™ç¯‡æ–‡ç« åé¢çš„é…ç½®åªæ˜¯è¿›è¡Œäº†ä¸€äº›æ”¹å˜å¹¶å¥—ç”¨åˆ° nftables ä¹‹ä¸Šï¼Œæ‰€ä»¥åœ¨çœŸæ­£å¼€å§‹é…ç½® Netfilter ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¯¹è‡ªå·±è®¾å®šçš„é…ç½®æ‰€äº§ç”Ÿçš„æ•ˆæœè¿›è¡Œä¸€å®šçš„äº†è§£ã€‚

é¦–å…ˆçœ‹ `iptables -t mangle -A V2RAY [something] -j RETURN`ï¼Œè¿™ä¸€å¥ä½œç”¨å¾ˆç®€å•ï¼ŒåŒ¹é…æŸäº›è§„åˆ™ï¼Œå°†è¿™äº›æ•°æ®åŒ… returnï¼Œä¹Ÿå°±æ˜¯è¿”å›ã€‚åœ¨å½“å‰ç¯å¢ƒä¸­ï¼Œæ•°æ®åŒ…ä¼šä»å­é“¾ V2RAY è¿”å›åˆ°çˆ¶é“¾ PREROUTING ä¸­ï¼Œç”±äº PREROUTING é“¾å¹¶æ²¡æœ‰è®¾ç½®ä»€ä¹ˆè§„åˆ™ï¼Œæ‰€ä»¥å°±æŒ‰ç¼ºçœè§„åˆ™ç›´æ¥è½¬å‘å‡ºå»ï¼Œè¾¾åˆ°äº†ç›´è¿çš„ç›®çš„ã€‚

æ¥ä¸‹æ¥çœ‹ `iptables -t mangle -A V2RAY -p tcp -j TPROXY --on-port 12345 --tproxy-mark 1` è¿™æ¡è§„åˆ™ï¼Œå®ƒæ˜¯æ‰€æœ‰è§„åˆ™ä¸­æœ€é‡è¦çš„ï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®åŒ…è½¬åˆ° V2Ray ä¸­è¿›è¡Œé€æ˜ä»£ç†ã€‚é—®é¢˜æ˜¯ä¸ºä»€ä¹ˆè¦åœ¨åé¢åŠ ä¸€ä¸ªæ ‡è®°ã€Œ1ã€å‘¢ï¼Ÿç›´æ¥è½¬åˆ°ç›®æ ‡ç«¯å£å¥½åƒä¹Ÿå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜å•Šï¼Ÿè¿™ä¸ªé—®é¢˜å°±æ¶‰åŠåˆ° Netfilter çš„æµé‡èµ°å‘ä»¥åŠ Linux çš„è·¯ç”±è¡¨äº†ã€‚

![](https://cdn.moecm.com/netfilter-packet-flow.svg)

<center><div class="image-caption">Netfilter ä¸­åŒ…çš„æµç¨‹å›¾[^8]</div></center>

åœ¨è¿™å¼ éå¸¸ç»å…¸çš„æµç¨‹å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œmangle è¡¨çš„ prerouting é“¾ä¸Šï¼Œæµé‡ä¼šæœ‰ä¸¤ä¸ªèµ°å‘ï¼Œå³ input å’Œ forwardï¼Œå…¶ä¸­ forward æ˜¯è½¬å‘åˆ°å¤–é¢ï¼Œinput æ˜¯åˆ°æœ¬æœºé‡Œé¢ï¼Œå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©æ•°æ®åŒ…èµ° input é“¾åˆ° V2Ray ä¸­è¿›è¡Œé€æ˜ä»£ç†ï¼ˆæˆ–è€…è¯´ï¼Œèµ°ä»€ä¹ˆé“¾ä¸é‡è¦ï¼Œåªè¦èƒ½ä»æŒ‡å®šç«¯å£è¿æ¥åˆ°æœ¬æœºå°±å¥½ï¼‰ã€‚ç„¶è€Œç°å®å¾ˆæ®‹é…·ï¼Œè·¯ç”±è¡¨å¯ä»¥æ§åˆ¶æµé‡èµ°å‘ï¼Œåœ¨é»˜è®¤è§„åˆ™ä¸­ï¼Œè·¯ç”±è¡¨é€šè¿‡ç›®æ ‡åœ°å€è¿›è¡ŒåŒ¹é…ï¼Œè€Œæˆ‘ä»¬é€æ˜ä»£ç†æµé‡çš„ç›®æ ‡åœ°å€æ˜¾ç„¶éƒ½æ˜¯å¤–éƒ¨è€Œä¸æ˜¯æœ¬æœºï¼Œæ‰€ä»¥å°±ä¼šèµ° forward åˆ°å¤–éƒ¨ä½†æ˜¯å´æ‰¾ä¸åˆ°é€æ˜ä»£ç†çš„ç›®æ ‡ä¹Ÿå°±æ˜¯ V2Ray ç›‘å¬çš„ç«¯å£ï¼Œå¯¼è‡´ç½‘ç»œè¿æ¥æ— æ³•å»ºç«‹ã€‚äºæ˜¯ä¾¿æœ‰äº†ä»¥ä¸‹æŒ‡ä»¤ï¼š`ip route add local default dev lo table 100`ï¼Œè¿™æ¡æŒ‡ä»¤æ˜¯å»ºç«‹ä¸€ä¸ªåä¸º 100 çš„è·¯ç”±è¡¨ï¼Œå¹¶æŒ‡å‘ `lo` ç½‘å¡å³æœ¬æœºï¼›`ip rule add fwmark 1 table 100` è¿™ä¸€æ¡åˆ™æ˜¯å»ºç«‹è·¯ç”±è¡¨ 100 çš„è§„åˆ™ï¼šåŒ¹é…æœ‰æ ‡è®° 1 çš„æ•°æ®åŒ…èµ°è·¯ç”±è¡¨ 100ã€‚é€šè¿‡è¿™ä¸¤æ¡æŒ‡ä»¤ä»¥åŠ Netfilter è§„åˆ™ä¸­å‘é€æ˜ä»£ç†æµé‡æ·»åŠ çš„æ ‡è®° 1ï¼Œå³å¯å®ç°å¯¹å±€åŸŸç½‘ä¸­å®¢æˆ·ç«¯çš„é€æ˜ä»£ç†ã€‚

æ¥ä¸‹æ¥å°±æ˜¯å¯¹æœ¬æœºçš„é€æ˜ä»£ç†éƒ¨åˆ†äº†ã€‚é¦–å…ˆæ˜¯ `iptables -t mangle -A V2RAY_MARK -p tcp -j MARK --set-mark 1` è¿™å¥ï¼Œå®ƒçš„ä½œç”¨ä¸ `iptables -t mangle -A V2RAY -p tcp -j TPROXYâ€¦` ä¸€å¥ç›¸åŒï¼Œé‚£ä¸ºä½•å†™æ³•å´å’Œåè€…ä¸åŒå‘¢ï¼Ÿæ˜¾ç„¶ï¼Œåœ¨ prerouting é“¾ä¸Šçš„é€æ˜ä»£ç†ä¸èƒ½åº”ç”¨äºæœ¬æœºï¼Œè€Œ postrouting é“¾ä¼šç›´æ¥å‡ºå»ï¼Œæ‰€ä»¥æœ€ååªèƒ½åœ¨ output é“¾ä¸Šè¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯ output é“¾ä¸Šå¹¶ä¸å…è®¸è®¾ç½®é€æ˜ä»£ç†ï¼Œå› ä¸ºå‡ºå»çš„åŒ…åˆä¼šå›åˆ°æœ¬æœºï¼Œé€ æˆäº†æ­»å¾ªç¯ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯ output é“¾ä¹‹åå°±æ˜¯ postrouting é“¾ï¼Œåˆä¸å­˜åœ¨è·¯ç”±åˆ¤æ–­ï¼Œæ‰€ä»¥åŒ…æ²¡æœ‰æœºä¼šèµ°å›æœ¬æœºï¼‰ã€‚å¥½åœ¨å¤©æ— ç»äººä¹‹è·¯ï¼Œoutput é“¾åå­˜åœ¨ä¸€ç§æœºåˆ¶å«åš reroute checkï¼Œé€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬åªéœ€å°†æ•°æ®åŒ…æ‰“ä¸Šå’Œå…ˆå‰ä¸€æ ·çš„æ ‡è®° `1`ï¼ŒéšåæŸ¥è·¯ç”±è¡¨åŒ¹é…è§„åˆ™ï¼Œé€šè¿‡ `lo` é‡æ–°å›åˆ°æœ¬æœºä¸­ï¼Œç„¶åå’Œå…¶ä»–ä»å¤–é¢æ¥çš„æµé‡ï¼ˆå¦‚å±€åŸŸç½‘è®¾å¤‡çš„é€æ˜ä»£ç†æµé‡ï¼‰æ··åœ¨ä¸€èµ·ï¼Œè¿›è¡Œé€æ˜ä»£ç†ã€‚æœ€åä¸€ä¸ªéœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯ä» V2Ray å‡ºæ¥çš„æµé‡åº”è¯¥å¦‚ä½•å¤„ç†ï¼Œå¦‚æœæŒ‰ç°æœ‰é…ç½®è¿è¡Œï¼Œä» V2Ray å‡ºæ¥çš„æµé‡ç»è¿‡ output é“¾æ—¶ä¼šé‡æ–°è¢«æ‰“å›ï¼Œé€ æˆæ­»å¾ªç¯ï¼Œæ‰€ä»¥åªæ˜¯éœ€è¦åœ¨ V2Ray å†…éƒ¨å‘å‡ºç«™çš„æ•°æ®åŒ…æ‰“ä¸€ä¸ªæ ‡è®°ã€Œ2ã€ï¼Œä¹Ÿå°±æ˜¯ `"mark": 2`ï¼Œç„¶ååœ¨ output é“¾ä¸Šé…ç½®æ ‡è®°ä¸º `2` çš„æ•°æ®åŒ…ç›´è¿ï¼Œä¹Ÿå°±æ˜¯ `iptables -t mangle -A V2RAY_MARK -j RETURN -m mark --mark 2`ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å¯¹æœ¬æœºçš„é€æ˜ä»£ç†äº†ã€‚

å¦å¤–è¿˜æœ‰ä¸€ä¸ªå¯ä»¥è®¨è®ºçš„ç‚¹ï¼šæ˜¯å¦éœ€è¦è®¾å®šæœåŠ¡å™¨ IP ç›´è¿ï¼Ÿåœ¨ output é“¾ä¸­ï¼Œå¦‚æœæ·»åŠ ä¸€æ¡ç›®æ ‡åœ°å€ä¸ºæœåŠ¡å™¨ IP ç›´è¿çš„è§„åˆ™ï¼ŒåŒæ—¶åˆ é™¤æ ‡è®° `2` ç›´è¿çš„è§„åˆ™ï¼Œé€æ˜ä»£ç†å¯ä»¥æ­£å¸¸è¿è¡Œã€‚è¿™æ˜¯å› ä¸ºä» V2Ray å‡ºæ¥çš„æ•°æ®åŒ…çš„ç›®æ ‡åœ°å€ä¸æ˜¯åŸåœ°å€è€Œæ˜¯ V2Ray æœåŠ¡å™¨åœ°å€ï¼Œæ‰€ä»¥å³ä½¿ä¸è¿‡æ»¤æ ‡è®°å°†ä» V2Ray å‡ºæ¥çš„æµé‡åˆ†æµï¼Œé€šè¿‡æ‰¾ç›®æ ‡åœ°å€çš„æ–¹å¼åˆ†æµä»ç„¶å¯ä»¥è¾¾åˆ°ç›®çš„ã€‚ä½†è¿™ç§æ–¹å¼å­˜åœ¨å¾ˆå¤šæ¼æ´ï¼šoutput é“¾ä¸Šè®¾å®šçš„è§„åˆ™ä¸ºç‰¹æ®Šåœ°å€ã€å›½å†…åœ°å€ã€æœåŠ¡å™¨åœ°å€ã€å…¶ä»–è‡ªå®šä¹‰åœ°å€ç›´è¿ï¼Œå¦‚æœå­˜åœ¨æŸä¸ªåœ°å€ï¼Œå®ƒä¸å±äºä»¥ä¸Š 4 ç§åœ°å€ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œåˆä¼šä» V2Ray çš„ Freedom å‡ºç«™åè®®ä¸­å‡ºæ¥ï¼Œå°±ä¼šå¯¼è‡´è®¿é—®æ­¤åœ°å€çš„æµé‡é™·å…¥æ­»å¾ªç¯ã€‚ç±»ä¼¼çš„æç«¯æƒ…å†µå¯èƒ½è¿˜æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥ output é“¾ä¸Šè®¾å®šæ ‡è®° `2` ç›´è¿æ˜¯å¿…è¦çš„ã€‚ä¸è¿‡åœ¨ prerouting é“¾ä¸Šé…ç½®ç›®æ ‡åœ°å€ä¸ºæœåŠ¡å™¨åœ°å€æ—¶ç›´è¿ä»¥åŠåœ¨ output é“¾ä¸Šé¢å¤–è®¾å®šæ­¤åœ°å€æ˜¯å¦å¿…è¦å‘¢ï¼Ÿå°±æˆ‘ä¸ªäººä½“éªŒå’Œç›®å‰çš„æ–¹æ¡ˆï¼ˆå•æœåŠ¡å™¨ä¸å¤šå®¢æˆ·ç«¯ï¼‰è€Œè¨€ï¼Œæ˜¯å¦è®¾ç½®æ²¡æœ‰å¤ªå¤šä½¿ç”¨ä¸Šçš„åŒºåˆ«ï¼Œæ‰€ä»¥æ ¹æ®å®é™…æƒ…å†µè®¾ç½®å°±å¥½ã€‚

æœ€åä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦åº”è¯¥è®¾ç½® masqueradeï¼Ÿåœ¨ä¸Šé¢æåˆ°çš„[å¯¹äºæ‰€è°“ã€Œæ—è·¯ç”±ã€çš„ç–‘æƒ‘ - V2EX](https://www.v2ex.com/t/663066) è®¨è®ºä¸­ï¼Œæœ‰å¦‚ä¸‹è§‚ç‚¹ï¼š[^9]

> <p>F å¤§çš„æ•™ç¨‹ä¸­æœ‰è¿™ä¹ˆä¸€å¥ï¼Œã€Œiptables -t nat -I POSTROUTING -j MASQUERADEã€ã€‚è¿™ä¼šå¯¼è‡´å›½å†…ä¸‹è½½æµé‡ç»è¿‡ N1 æ—è·¯ç”±ï¼Œå› ä¸º MASQUERADE ä¼šå°† source ip æ›¿æ¢ä¸º N1 çš„ ipï¼Œä¸ç®¡æ˜¯å¦å¯Œå¼ºï¼ˆæ³¨ï¼šåº”è¯¥æŒ‡ç¿»å¢™ï¼‰ã€‚</p>
>
> åœ¨ N1 ä¸Š POSTROUTING MASQUERADE æ¯«æ— å¿…è¦ï¼Œé™¤éå°† N1 å½“ä½œä¸»è·¯ç”±ã€‚

è¿™ä¸ªè§‚ç‚¹å¾ˆæ˜ç¡®ï¼Œè€Œä¸”é€»è¾‘ä¸Šä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä»ä¸»è·¯ç”±ç›´æ¥è¿æ¥åˆ°å®¢æˆ·ç«¯è‚¯å®šæ¯”ç»è¿‡æ—è·¯ç”±æ›´å¿«ã€‚ç„¶è€Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œåœ¨ä¸è®¾å®š masquerade çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸæµé‡åœ¨ Netfilter ä¸­ç›´æ¥ç›´è¿åˆ°å¤–é¢ï¼Œè€Œä¸ç»è¿‡ V2Rayï¼Œå°±ä¼šå‡ºç°å„ç§é—®é¢˜ï¼Œå¦‚ï¼šå›½å†…ç½‘é¡µåŠ è½½æå…¶ç¼“æ…¢ç”šè‡³æ— æ³•åŠ è½½ï¼›SSH è¿æ¥åœ¨å¿«é€Ÿè¾“å…¥å­—ç¬¦æˆ–å¿«é€Ÿç§»åŠ¨å…‰æ ‡ç­‰é”®ç›˜æ“ä½œæ—¶ä¼šå¯¼è‡´ SSH æ‰çº¿ã€‚ä¹‹å‰ç”±äºæˆ‘é€‰æ‹©åœ¨ V2Ray ä¸­è¿›è¡Œåˆ†æµæ“ä½œï¼Œæ‰€ä»¥é‡åˆ° SSH æ‰çº¿é—®é¢˜æ—¶å¹¶æ²¡æœ‰å¤ªè¿‡æ³¨æ„ï¼Œç›´åˆ°è¿™æ¬¡ä¿®æ”¹é…ç½®åï¼Œä¹‹å‰ç™¾æ€ä¸å¾—å…¶è§£çš„é—®é¢˜ç»ˆäºå¾—åˆ°è§£å†³ã€‚è™½ç„¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„ç»“æœï¼Œæ€»ä¹‹ä½¿ç”¨ä½“éªŒè‰¯å¥½å°±æ˜¯äº†ã€‚

### nftables é…ç½®

æ— è®ºæ˜¯ iptables è¿˜æ˜¯ nftablesï¼Œéƒ½éœ€è¦å…ˆé…ç½®ç­–ç•¥è·¯ç”±ã€‚

```shell
# ip route add local default dev lo table 100 # æ·»åŠ è·¯ç”±è¡¨ 100
# ip rule add fwmark 1 table 100 # ä¸ºè·¯ç”±è¡¨ 100 è®¾å®šè§„åˆ™
```

ä¸ iptables ä¸åŒï¼Œnftables çš„è®¾å®šåå‘äºç¼–è¾‘æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ‰§è¡ŒæŒ‡ä»¤ã€‚`iptables-save`  å’Œ `iptables-restore` çš„ç¡®å¯ä»¥ä¿å­˜å’Œæ¢å¤ iptables é…ç½®ï¼Œä½†ç”Ÿæˆçš„æ–‡ä»¶å¯è¯»æ€§å·®ã€‚nftables çš„é…ç½®æ–‡ä»¶å®¹æ˜“ç¼–è¾‘å’Œé˜…è¯»ï¼ŒæŒ‡ä»¤æ‰§è¡Œçš„è¯­å¥å…¶å®å’Œé…ç½®æ–‡ä»¶çš„å†™æ³•ç›¸åŒï¼Œä¸è¿‡è¿™å°±ä¼šå¯¼è‡´å¾ˆå¤šç¬¦å·ä¼šåœ¨ Shell ä¸­è¢«è¯†åˆ«ä¸ºå…¶ä»–å«ä¹‰ï¼Œå¯èƒ½éœ€è¦è½¬ä¹‰ã€åŠ å¼•å·ã€åŠ ç©ºæ ¼ç­‰æ–¹å¼è§„é¿é—®é¢˜ï¼Œä½“éªŒè¾ƒå·®ã€‚è™½ç„¶ nftables æä¾›äº†ä¸€ä¸ªäº’åŠ¨æ¨¡å¼ï¼Œä½†æ˜¯æˆ‘æ›´æ„¿æ„å»å†™é…ç½®æ–‡ä»¶ï¼Œè¿è¡ŒæŒ‡ä»¤ä»…ä½œä¸ºå®éªŒæ–¹å¼ï¼ˆæœ‰ç‚¹åƒ Pythonï¼Ÿï¼‰ã€‚

é¦–å…ˆç¼–è¾‘ `/etc/nftables.conf`ï¼š

```
#!/usr/sbin/nft -f

flush ruleset

include "/etc/nftables.d/*"

table ip v2ray {
	chain prerouting {
		type filter hook prerouting priority mangle; policy accept;
		ip daddr { $RESERVED_IP, $CHINA_IP, 8.8.4.4, 208.67.222.222, 104.27.159.178 } return
		ip protocol tcp tproxy to 127.0.0.1:12345 meta mark set 1
		ip protocol udp tproxy to 127.0.0.1:12345 meta mark set 1
	}
	chain output {
		type route hook output priority mangle; policy accept;
		ip daddr { $RESERVED_IP, $CHINA_IP, 8.8.4.4, 208.67.222.222, 104.27.159.178 } return
		meta mark 2 return
		ip protocol tcp meta mark set 1
		ip protocol udp meta mark set 1
	}
	chain postrouting {
		type nat hook postrouting priority srcnat; policy accept;
		masquerade
	}
}
```

ä¹‹ååˆ›å»º `/etc/nftables.d` æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»º `reserved_ip.conf`ã€`china_ip.conf` ä¸¤ä¸ªæ–‡ä»¶ã€‚

```
define RESERVED_IP = {
    10.0.0.0/8,
    100.64.0.0/10,
    127.0.0.0/8,
    169.254.0.0/16,
    172.16.0.0/12,
    192.0.0.0/24,
    192.168.0.0/16,
    224.0.0.0/4,
    240.0.0.0/4,
    255.255.255.255/32
}
```

```
define CHINA_IP = {
    1.1.8.0/24,
    1.2.4.0/24,
    â€¦
    223.255.252.0/23
}
```

å›½å†… IP çš„å®Œæ•´åˆ—è¡¨å¯ä»¥é€šè¿‡ä¸Šæ–‡ DNS éƒ¨åˆ†æåˆ°çš„æŒ‡ä»¤ç”Ÿæˆï¼Œç„¶åå†™æˆç›¸åŒæ ¼å¼å³å¯ã€‚

ä¹‹åç¼–è¾‘ `/lib/systemd/system/nftables.service`ã€‚

```ini
[Unit]
Description=nftables
Documentation=man:nft(8) http://wiki.nftables.org
Wants=network-pre.target
Before=network-pre.target shutdown.target
Conflicts=shutdown.target
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
StandardInput=null
ProtectSystem=full
ProtectHome=true
ExecStart=/usr/sbin/nft -f /etc/nftables.conf ; /usr/sbin/ip route add local default dev lo table 100 ; /usr/sbin/ip rule add fwmark 1 table 100
ExecReload=/usr/sbin/nft -f /etc/nftables.conf
ExecStop=/usr/sbin/nft flush ruleset ; /usr/sbin/ip route del local default dev lo table 100 ; /usr/sbin/ip rule del table 100

[Install]
WantedBy=sysinit.target
```

æœ€åè®¾å®šå¼€æœºå¹¶ç«‹å³å¯åŠ¨å³å¯ã€‚

```shell
# systemctl enable nftables --now
```

## 5. V2Ray ä¸­çš„ UDP åè®®

æˆ‘ä»¬å…ˆä»å°çš„åœ°æ–¹è¯´èµ·ã€‚

æ–‡ç« å¼€å¤´ï¼Œæˆ‘å°±æåˆ°äº†ä¸€äº›ä½¿ç”¨ UDP åè®®é€šè®¯çš„ä¼šè®®è½¯ä»¶åœ¨é€æ˜ä»£ç†ç¯å¢ƒä¸­å­˜åœ¨æ–­æµç°è±¡ã€‚ä¹‹å‰ä¸€ç›´ä»¥ä¸ºæ˜¯æˆ‘ä¸ªäººé—®é¢˜ï¼Œåæ¥æ‰äº†è§£åˆ°è¿™æ˜¯ä¸€ä¸ªå…±æ€§é—®é¢˜ï¼Œæ¯”å¦‚ï¼š[ä½¿ç”¨ QUIC åè®®è§‚çœ‹è§†é¢‘æ–­æµ](https://github.com/v2ray/v2ray-core/issues/1432)ï¼Œ[Zoom ä¼šè®®æ–­æµ](https://youth2009.org/v2ray-transparent-proxy-and-zoom-udp-optimization/)â€¦â€¦

å¥½åœ¨çœ‹åˆ°äº†åé¢çš„é‚£ç¯‡åšå®¢ï¼Œä¹Ÿè¶ç€è¿™æ¬¡ä¿®æ”¹é…ç½®ï¼Œé€šè¿‡ Netfilter è¿›è¡Œåˆ†æµï¼Œä½¿å›½å†…æµé‡ç›´è¿è€Œä¸é€šè¿‡ V2Rayï¼Œä¸€å®šç¨‹åº¦ä¸Šè§„é¿äº† UDP æ–­æµçš„é—®é¢˜ï¼Œå®é™…ä½¿ç”¨æ—¶ä¹Ÿååˆ†èˆ’é€‚ï¼Œä¸æ­£å¸¸ä½¿ç”¨å‡ ä¹æ²¡æœ‰åŒºåˆ«ã€‚ä¸è¿‡å¦‚æœç”¨ V2Ray ä»£ç†æ¸¸æˆå¯èƒ½ä½“éªŒå°±æ²¡é‚£ä¹ˆå‹å¥½äº†ã€‚

åœ¨ä¸Šæ–‡ DNS éƒ¨åˆ†æåˆ°çš„ 53 ç«¯å£é—®é¢˜åŒæ ·ä¸ UDP æœ‰å…³ã€‚

æ­¤å¤–ï¼Œé™¤ mKCP å’Œ QUIC ä»¥å¤–ï¼ŒV2Ray çš„å…¶ä»–ä¼ è¾“æ–¹å¼éƒ½æ˜¯ UDP over TCPï¼Œå³ä½¿ç”¨ TCP ä¼ è¾“ UDPã€‚ä»å„ä¸ªæ–¹é¢æ¥çœ‹ï¼ŒV2Ray å¯¹ UDP åè®®å¹¶ä¸å‹å¥½ï¼Œéšç€ç½‘ç»œæŠ€æœ¯æ›´æ–°æ¢ä»£ï¼ŒHTTP/3 æ™®åŠï¼ŒQUIC åè®®ä¼šè¢«å¹¿æ³›ä½¿ç”¨ï¼Œé‚£æ—¶å€™ï¼ŒUDP çš„é‡è¦æ€§ä¼šè¿œè¶…å½“ä¸‹ï¼Œæ‰€ä»¥æˆ‘å¾ˆæœŸå¾… V2Ray å°†æ¥å¯¹ UDP çš„ä¼˜åŒ–ã€‚

## 6. æ˜¯å¦å¯ç”¨ IPv6ï¼Ÿ

è‡³å°‘å¯¹äºæˆ‘æ¥è¯´ï¼ŒNoã€‚

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ç®€è¦çš„è®°å½•äº†æˆ‘å¯¹ IPv6 çš„ä¸€äº›äº†è§£ï¼Œè™½ç„¶æ¯”è¾ƒæ··ä¹±ï¼Œä½†è¿˜æ˜¯è¯´æ˜äº†ä¸€äº›ä¸œè¥¿ã€‚é¦–å…ˆæˆ‘æ˜¯æ”¯æŒ IPv6 çš„ï¼Œæ— è®ºä»å‘å±•è¶‹åŠ¿è¿˜æ˜¯ä½¿ç”¨æ•ˆæœä¸Šæ¥è¯´ï¼ŒIPv6 éƒ½æœ‰ç€ä¸å°‘çš„ä¼˜ç‚¹ã€‚æ¯”å¦‚éšç€å¸¦å®½èƒ½åŠ›çš„æå‡ï¼Œä»¥åŠç»ˆç«¯æ•°é‡çš„å¢åŠ ï¼ŒNAT çš„å¼Šç«¯å·²ç»é€æ­¥ä½“ç°å‡ºæ¥äº†ï¼Œè€Œ IPv6 çš„å‡ºç°èƒ½å¤ŸçœŸæ­£ä½¿æ¯ä¸€å°è®¾å¤‡éƒ½æœ‰è‡³å°‘ä¸€ä¸ª**çœŸæ­£çš„äº’è”ç½‘å…¬ç½‘åœ°å€**ï¼Œä¹Ÿå°±æ˜¯ã€Œå…¨çƒå•æ’­åœ°å€ã€ï¼Œæ‰€è°“ IPv6 è‡ªå¸¦å†…ç½‘ç©¿é€ç‰¹æ€§æ­£æ˜¯è¯´å®ƒä¸åŒäº IPv4 çš„åœ°å€åˆ†é…æ–¹å¼ä»¥åŠåœ°å€æ•°é‡çš„åºå¤§ã€‚ç„¶è€Œä»å¦ä¸€æ–¹é¢ï¼Œæˆ‘æ„Ÿåˆ° IPv6 çš„å¤æ‚ã€‚ä» IP åœ°å€æ ¼å¼åˆ° IP åœ°å€åˆ†é…ï¼Œéƒ½ä»¤äººæ„Ÿåˆ°è´¹è§£ã€‚

å¦‚æœè¯´è¿™äº›æ‰€è°“çš„ IPv6 ç¼ºé™·åªæ˜¯ä¸€æ—¶çš„éš¾ä»¥é€‚åº”ä»¥åŠç›¸å…³çŸ¥è¯†çš„ç¼ºä¹ï¼Œé‚£ä¹ˆé’ˆå¯¹æˆ‘çš„å®é™…ä½“éªŒæƒ…å†µè€Œè¨€ï¼Œæˆ‘çš„ç¡®æ— æ³•é€‰æ‹©ä½¿ç”¨ IPv6ï¼Œè¿™ä¸ªé—®é¢˜çš„å…³é”®ä¹Ÿè®¸å°±åœ¨äºä¸»è·¯ç”±ä¹‹ä¸Šã€‚é¦–å…ˆè¯·å»æµè§ˆä¸€ä¸‹è¿™ä½æœ‹å‹çš„éš¾é¢˜ï¼š[å¦‚ä½•æ›´æ”¹ IPv6 è·¯ç”±é€šå‘Šä¸‹å‘çš„é»˜è®¤è·¯ç”±ç½‘å…³é…ç½® - V2EX](https://www.v2ex.com/t/685344)ã€‚ä»–çš„é—®é¢˜ä¸ä»…ä»£è¡¨äº†æˆ‘çš„é—®é¢˜ï¼ŒåŒæ—¶è¿˜ç®€è¿°äº† IPv6 çš„åœ°å€åˆ†é…æœºåˆ¶ï¼Œæ­£æ˜¯å› ä¸ºè¿™ç§æœºåˆ¶ï¼Œæˆ‘æ— æ³•ä½¿æ—è·¯ç”±ä½œä¸ºç½‘å…³ä»¥æä¾›é€æ˜ä»£ç†ã€‚æˆ–è®¸é€šè¿‡æ›´æ”¹ä¸»è·¯ç”±çš„é…ç½®å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç„¶è€Œå®¶é‡Œçš„å°ç±³è·¯ç”±å™¨æ—¢ç¼ºé™·å„ç§åŠŸèƒ½ï¼Œä¹Ÿæ— æ³•åˆ·æˆå…¶ä»–çš„è·¯ç”±å™¨ç³»ç»Ÿã€‚ç»¼ä¸Šï¼Œåœ¨æˆ‘æ— æ•°æ¬¡å®éªŒä¹‹ä¸­ï¼Œæˆ‘æ”¾å¼ƒäº†ã€‚

è€Œåœ¨å®é™…ä½“éªŒè¿™ç§ IPv4 å•æ ˆé€æ˜ä»£ç†çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿç¡®å®å‡ºç°äº†ä¸å°‘çš„é—®é¢˜ã€‚æ¯”å¦‚ï¼Œç”±äº IPv6 ä¼˜å…ˆåŸåˆ™ï¼ŒDNS è§£æåˆ° IPv6 åœ°å€åä¼šå¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œè€Œè¿™ä¸ªåœ°å€ä¹Ÿè®¸è¢«æ±¡æŸ“äº†ï¼Œæˆ–è€…å³ä½¿æ˜¯æ­£ç¡®çš„ï¼Œä¹Ÿå› ä¸ºæ— æ³•è¿›è¡Œé€æ˜ä»£ç†è€Œæ— æ³•è®¿é—®ã€‚

æœ‰è¿™æ ·ä¸€ä¸ªå®é™…ä¾‹å­ï¼šåœ¨ä½¿ç”¨ Magisk æ¨¡å—ä»“åº“ä¸­ï¼Œå‘ç°ä»“åº“åˆ—è¡¨æ— æ³•åˆ·æ–°ï¼Œé€šè¿‡æŠ“åŒ…åå‘ç°ï¼ŒMagisk çš„ä»“åº“åˆ—è¡¨ä½äº GitHub ä¹‹ä¸Šï¼Œè™½ç„¶ GitHub å¹¶æ²¡æœ‰ IPv6 åœ°å€ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿä½¿ç”¨ IPv6 çš„ DNS æœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ï¼Œè€Œ IPv6 çš„ DNS æœåŠ¡å™¨å¹¶æ²¡æœ‰è¿›è¡Œ DNS æ±¡æŸ“å¤„ç†ï¼Œä»è€Œä½¿å¾—æŸ¥è¯¢åˆ°çš„ IPv4 åœ°å€ä¸å¯ç”¨ï¼Œæœ€ç»ˆå¯¼è‡´ Magisk æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚åœ¨å…³é—­äº†æ‰‹æœºçš„ IPv6 ä¹‹åï¼ŒåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚

è¿ GitHub éƒ½æ²¡æœ‰ IPv6 åœ°å€ï¼Œè¯´æ˜ IPv6 çš„å®é™…ä½¿ç”¨ç‡å®åœ¨æ˜¯ä½ï¼Œç”Ÿæ´»ä¸­ä¹Ÿå¾ˆå°‘èƒ½å¤Ÿå‘ç°åªèƒ½ IPv6 è®¿é—®æœåŠ¡ï¼ˆæ¯”å¦‚å•æ ˆ IPv6 VPSï¼‰ï¼Œæ‰€ä»¥çš„ç¡®æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚

> ç„¶è€Œæˆ‘åœ¨å†™è¿™ä¸€æ®µçš„æ—¶å€™å¿½ç„¶æƒ³åˆ°æ˜¯å¦å­˜åœ¨ä»¥ä¸‹å¯èƒ½ï¼šå¼€å¯ä¸»è·¯ç”± IPv6ï¼Œé…ç½® DNS æœåŠ¡å™¨æŒ‡å‘æ—è·¯ç”±çš„ Link-local é“¾è·¯æœ¬åœ°åœ°å€ï¼Œç„¶ååœ¨æ—è·¯ç”±ä¸Šå…³é—­ IPv6 åœ°å€çš„ DNS æŸ¥è¯¢ï¼Œå¦‚æ­¤å°±å¯ä»¥åšåˆ°åŸŸåè®¿é—®å¿…èµ° IPv4 é€æ˜ä»£ç†ï¼ŒåŒæ—¶åˆå¯ä»¥ä½¿ç”¨ IPv6 åŠŸèƒ½ã€‚å¾…æµ‹è¯•ã€‚

> è¿™ç§äº‹æƒ…æ„Ÿè§‰æ²¡æœ‰ä»€ä¹ˆä»·å€¼ï¼Œæ²¡å¿…è¦ä¸ºäº† IPv6 è€Œ IPv6ã€‚

## 7. ä¸€äº›å…³äº V2Ray çš„æ–°ä¸œè¥¿

### æ–‡æ¡£ç•Œé¢

V2Ray å’Œ V2Fly æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿç®€å•æ¥è¯´ï¼ŒV2Fly æ˜¯ V2Ray çš„ç¤¾åŒºç‰ˆã€‚ç”±äº V2Ray åŸå¼€å‘è€… Victoria Raymond é•¿æœŸå¤±è”ï¼Œä¸ºæ–¹ä¾¿ç®¡ç†å’Œç»´æŠ¤ï¼ŒV2Ray çš„å¼€å‘è€…ä»¬è‡ªå‘çš„ Fork äº† V2Ray é¡¹ç›®ä»¥åŠå®˜ç½‘ç­‰å†…å®¹ã€‚æ‰€ä»¥æŸ¥æ‰¾èµ„æ–™æ—¶è¯·æµè§ˆ v2fly.org è€Œä¸æ˜¯ v2ray.comï¼Œåè€…å·²ç»æ— äººç»´æŠ¤ï¼Œå¾ˆå¤šå†…å®¹å·²ç»è¿‡æ—¶å¹¶å­˜åœ¨ç¼ºå¤±ï¼Œè€Œå‰è€…ä¸€ç›´è¢«ç¤¾åŒºç»´æŠ¤ï¼Œä¸ä¹…ä¹‹å‰è¿˜é‡æ„äº†é¡µé¢ï¼Œæ›´åŠ ç¾è§‚ã€æ˜“è¯»ã€‚

å¦å¤–ä¼—æ‰€å‘¨çŸ¥çš„ç”± ToutyRater å¤§ä½¬ç¼–å†™çš„ V2Ray ç™½è¯æ–‡æ•™ç¨‹ toutyrater.github.io å·²å…¨éƒ¨è¿ç§»åˆ°[æ–° V2Ray ç™½è¯æ–‡æŒ‡å—](https://guide.v2fly.org/) guide.v2fly.orgï¼Œå¹¶ä¸æ–­æ›´æ–°æ›´å¤šçš„ V2Ray ç©æ³•ï¼Œç”±ç¤¾åŒºç»´æŠ¤ï¼Œæ¬¢è¿æäº¤ PR æ¥å®Œå–„æœ¬æŒ‡å—ã€‚

### å®‰è£…æ–¹å¼

ä¹‹å‰å®‰è£… V2Ray éƒ½æ˜¯ä½¿ç”¨æˆ‘è®¤ä¸ºåŸŸåå¾ˆå¥½çš„é‚£ä¸ªè„šæœ¬ï¼ˆhttps://install.direct/go.shï¼‰è¿›è¡Œå®‰è£…ï¼Œä½†åœ¨ V2Ray æ–‡æ¡£ä¸­æåˆ°ï¼Œä¸å†æ¨èä½¿ç”¨è€è„šæœ¬ï¼Œè½¬ä¸ºä½¿ç”¨æ–°è„šæœ¬ï¼ˆåŸå› åŠåŒºåˆ«è¯·è‡ªè¡Œæµè§ˆ[æ–‡æ¡£](https://www.v2fly.org/guide/install.html#linux-å®‰è£…è„šæœ¬)ï¼‰ã€‚

> ç›®å‰ V2Ray é¡¹ç›®ç»„å·²ç»å°†è€è„šæœ¬åºŸå¼ƒï¼Œè½¬ä¸ºä½¿ç”¨æ–°è„šæœ¬ã€‚

```shell
$ wget https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh
# bash install-release.sh
```

### è‡ªå®šä¹‰è§„åˆ™

é™¤äº†å®‰è£…è„šæœ¬ä»¥å¤–ï¼Œé¡¹ç›®ä¸­è¿˜æä¾›äº†ä¸€ä¸ªç”¨äºæ›´æ–°å†…ç½®è§„åˆ™æ–‡ä»¶çš„è„šæœ¬ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä¸ä¼šå»ä½¿ç”¨å®ƒã€‚åŸå› æ˜¯æˆ‘ä½¿ç”¨äº†å…¶ä»–çš„æ–‡ä»¶å»ä»£æ›¿å®˜æ–¹å†…ç½®çš„æ–‡ä»¶ï¼š[Loyalsoldier/v2ray-rules-dat: ğŸ¦„ ğŸƒ ğŸ‘» V2Ray è·¯ç”±è§„åˆ™æ–‡ä»¶åŠ å¼ºç‰ˆï¼Œå¯ä»£æ›¿å®˜æ–¹è§„åˆ™æ–‡ä»¶ã€‚Enhanced edition of V2Ray routing rules dat files.](https://github.com/Loyalsoldier/v2ray-rules-dat)ã€‚æ­¤é¡¹ç›®å·²è¢«æ”¶å…¥å®˜ç½‘æ–‡æ¡£ä¹‹ä¸­ã€‚å®ƒç›¸å½“äºå®˜æ–¹è§„åˆ™çš„è¶…é›†ï¼Œå¹¶æ·»åŠ äº†æ›´å¤šçš„ç±»åˆ«ï¼Œæ¯å¤© Github Actions è‡ªåŠ¨ç”Ÿæˆã€‚æ›´æ£’çš„æ˜¯ï¼ŒåŸŸåè§„åˆ™å¯ä»¥é€šè¿‡ Fork æ­¤é¡¹ç›®è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆè§„åˆ™æ–‡ä»¶ã€‚

### å¤šæ–‡ä»¶é…ç½®

> è‡ªç‰ˆæœ¬ `4.23.0` èµ·ï¼ŒV2Ray ç¨‹åºæ”¯æŒä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶ã€‚
>
> å¤šé…ç½®æ–‡ä»¶çš„ä¸»è¦ä½œç”¨åœ¨äºåˆ†æ•£ä¸åŒä½œç”¨æ¨¡å—é…ç½®ï¼Œä¾¿äºç®¡ç†å’Œç»´æŠ¤ã€‚è¯¥åŠŸèƒ½ä¸»è¦è€ƒè™‘æ˜¯ä¸ºäº†ä¸°å¯Œ V2Ray çš„ç”Ÿæ€é“¾ï¼Œæ¯”å¦‚å¯¹äº GUI çš„å®¢æˆ·ç«¯ï¼Œä¸€èˆ¬åªå®ç°èŠ‚ç‚¹é€‰æ‹©ç­‰å›ºå®šçš„åŠŸèƒ½ï¼Œå¯¹äºå¤ªå¤æ‚çš„é…ç½®éš¾ä»¥å›¾å½¢åŒ–å®ç°ï¼›åªéœ€ç•™ä¸€ä¸ª `confdir` çš„è‡ªå®šä¹‰é…ç½®ç›®å½•ä¾›é…ç½®å¤æ‚çš„åŠŸèƒ½ï¼›å¯¹äºæœåŠ¡å™¨çš„éƒ¨ç½²è„šæœ¬ï¼Œåªéœ€å¾€ `confdir` æ·»åŠ æ–‡ä»¶å³å¯å®ç°é…ç½®å¤šç§åè®®ï¼Œç­‰ç­‰ã€‚[^10]

é€šè¿‡è¿™æ ·çš„ä¸€ä¸ªæ–°çš„è®¾è®¡ï¼Œæˆ‘å°†é…ç½®æ–‡ä»¶åˆ†ä¸ºè·¯ç”±éƒ¨åˆ†ã€DNS æœåŠ¡å™¨éƒ¨åˆ†ï¼ˆä¹‹å‰ï¼‰å’Œå…¶ä»–é…ç½®æ–‡ä»¶éƒ¨åˆ†ï¼Œåœ¨ç»“åˆä¸Šé¢æåˆ°çš„è‡ªå®šä¹‰è§„åˆ™ï¼Œç°åœ¨çš„é…ç½®æ–‡ä»¶æ›´ä¾¿äºç»´æŠ¤ï¼Œçœ‹èµ·æ¥æ›´åŠ èµå¿ƒæ‚¦ç›®ã€‚

é¦–å…ˆç¼–è¾‘ `/usr/local/etc/v2ray/00_base.json`ï¼ˆä½¿ç”¨æ–°è„šæœ¬å®‰è£…çš„ V2Ray é…ç½®æ–‡ä»¶ç›®å½•ï¼‰ï¼š

```json
{
  "log": {
    "error": "/var/log/v2ray/error.log",
    "access": "/var/log/v2ray/access.log",
    "loglevel": "error"
  },
  "inbounds": [
    {
      "port": 12345,
      "protocol": "dokodemo-door",
      "settings": {
        "network": "tcp,udp",
        "followRedirect": true
      },
      "sniffing": {
        "enabled": true,
        "destOverride": [
          "http",
          "tls"
        ]
      },
      "streamSettings": {
        "sockopt": {
          "tproxy": "tproxy"
        }
      }
    },
    {
      "port": 1080,
      "protocol": "socks",
      "sniffing": {
        "enabled": true,
        "destOverride": [
          "http",
          "tls"
        ]
      },
      "settings": {
        "auth": "noauth",
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "tag": "direct",
      "protocol": "freedom",
      "settings": {
        "domainStrategy": "UseIPv4"
      },
      "streamSettings": {
        "sockopt": {
          "mark": 2
        }
      }
    },
    {
      "tag": "proxy",
      "protocol": "vmess",
      "settings": {
        "vnext": [
          {
            "address": "æœåŠ¡ç«¯åœ°å€æˆ–åŸŸå",
            "port": æœåŠ¡ç«¯ç«¯å£,
            "users": [
              {
                "id": "UUID",
                "alterId": 4,
                "security": "auto"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "tls",
        "sockopt": {
          "mark": 2
        }
      }
    },
    {
      "tag": "block",
      "protocol": "blackhole",
      "settings": {
        "response": {
          "type": "http"
        }
      }
    }
  ]
}
```

ç„¶åç¼–è¾‘ `/usr/local/etc/v2ray/01_routing.json`ï¼š

```json
{
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
      {
        "type": "field",
        "outboundTag": "block",
        "domain": [
          "geosite:category-ads-all",
          "adservice"
        ]
      },
      {
        "type": "field",
        "outboundTag": "block",
        "ip": [
          "101.227.97.240/32",
          "101.227.200.11/32",
          "101.227.200.28/32",
          "124.192.153.42/32",
          "39.107.15.115/32",
          "47.89.59.182/32",
          "103.49.209.27/32",
          "123.56.152.96/32",
          "61.160.200.223/32",
          "61.160.200.242/32",
          "61.160.200.252/32",
          "61.174.50.214/32",
          "111.175.220.163/32",
          "111.175.220.164/32",
          "122.229.8.47/32",
          "122.229.29.89/32",
          "124.232.160.178/32",
          "175.6.223.15/32",
          "183.59.53.237/32",
          "218.93.127.37/32",
          "221.228.17.152/32",
          "221.231.6.79/32",
          "222.186.61.91/32",
          "222.186.61.95/32",
          "222.186.61.96/32",
          "222.186.61.97/32",
          "106.75.231.48/32",
          "119.4.249.166/32",
          "220.196.52.141/32",
          "221.6.4.148/32",
          "114.247.28.96/32",
          "221.179.131.72/32",
          "221.179.140.145/32",
          "115.182.16.79/32",
          "118.144.88.126/32",
          "118.144.88.215/32",
          "118.144.88.216/32",
          "120.76.189.132/32",
          "124.14.21.147/32",
          "124.14.21.151/32",
          "180.166.52.24/32",
          "211.161.101.106/32",
          "220.115.251.25/32",
          "222.73.156.235/32"
        ]
      },
      {
        "type": "field",
        "outboundTag": "proxy",
        "domain": [
          "geosite:geolocation-!cn",
          "pinterest",
          "porn",
          "github",
          "githubusercontent",
          "blogspot",
          "alibabacloud",
          "wikileaks",
          "nyaa.si",
          "rarbg"
        ]
      },
      {
        "type": "field",
        "outboundTag": "proxy",
        "ip": [
          "109.239.140.0/24",
          "14.102.250.18",
          "14.102.250.19",
          "149.154.164.0/22",
          "149.154.168.0/22",
          "149.154.172.0/22",
          "174.142.105.153",
          "50.7.31.230",
          "67.220.91.15",
          "67.220.91.18",
          "67.220.91.23",
          "69.65.19.160",
          "72.52.81.22",
          "85.17.73.31",
          "91.108.4.0/22",
          "91.108.56.0/22",
          "91.108.56.0/23",
          "108.177.120.94",
          "108.177.120.0/24",
          "172.217.0.0/16",
          "74.125.0.0/16",
          "geoip:jp",
          "geoip:us",
          "geoip:sg",
          "geoip:hk",
          "geoip:tw",
          "23.246.0.0/18",
          "37.77.184.0/21",
          "45.57.0.0/17",
          "64.120.128.0/17",
          "66.197.128.0/17",
          "108.175.32.0/20",
          "192.173.64.0/18",
          "198.38.96.0/19",
          "198.45.48.0/20",
          "173.245.48.0/20",
          "103.21.244.0/22",
          "103.22.200.0/22",
          "103.31.4.0/22",
          "141.101.64.0/18",
          "108.162.192.0/18",
          "190.93.240.0/20",
          "188.114.96.0/20",
          "197.234.240.0/22",
          "198.41.128.0/17",
          "162.158.0.0/15",
          "104.16.0.0/12",
          "172.64.0.0/13",
          "131.0.72.0/22",
          "144.220.0.0/16",
          "52.124.128.0/17",
          "54.230.0.0/16",
          "54.239.128.0/18",
          "52.82.128.0/19",
          "99.84.0.0/16",
          "204.246.172.0/24",
          "54.239.192.0/19",
          "70.132.0.0/18",
          "13.32.0.0/15",
          "205.251.208.0/20",
          "13.224.0.0/14",
          "13.35.0.0/16",
          "204.246.164.0/22",
          "204.246.168.0/22",
          "71.152.0.0/17",
          "216.137.32.0/19",
          "205.251.249.0/24",
          "99.86.0.0/16",
          "52.46.0.0/18",
          "52.84.0.0/15",
          "204.246.173.0/24",
          "130.176.0.0/16",
          "205.251.200.0/21",
          "204.246.174.0/23",
          "64.252.128.0/18",
          "205.251.254.0/24",
          "143.204.0.0/16",
          "205.251.252.0/23",
          "204.246.176.0/20",
          "13.249.0.0/16",
          "54.240.128.0/18",
          "205.251.250.0/23",
          "52.222.128.0/17",
          "54.182.0.0/16",
          "54.192.0.0/16",
          "2400:cb00::/32",
          "2606:4700::/32",
          "2803:f800::/32",
          "2405:b500::/32",
          "2405:8100::/32",
          "2a06:98c0::/29",
          "2c0f:f248::/32",
          "103.2.30.0/23",
          "125.209.208.0/20",
          "147.92.128.0/17",
          "203.104.144.0/21",
          "91.108.4.0/22",
          "91.108.8.0/22",
          "91.108.12.0/22",
          "91.108.16.0/22",
          "91.108.56.0/22",
          "149.154.160.0/20",
          "2001:b28:f23d::/48",
          "2001:b28:f23f::/48",
          "2001:67c:4e8::/48",
          "3.123.36.126/32",
          "35.157.215.84/32",
          "35.157.217.255/32",
          "52.58.209.134/32",
          "54.93.124.31/32",
          "54.162.243.80/32",
          "54.173.34.141/32",
          "54.235.23.242/32",
          "169.45.248.118/32"
        ]
      }
    ]
  }
}
```

## What else?

åˆ°è¿™é‡Œï¼Œæˆ‘çŸ¥é“çš„ææ€•éƒ½è®²å®Œäº†ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ä¸€äº›è¯æƒ³è¯´ä¸€è¯´ã€‚å…¶å®æœ¬æ¥è¿™ç¯‡æ–‡ç« ä¸ä¼šæ‹–åˆ°è¿™ä¹ˆæ™šæ‰å†™å®Œï¼Œä¸»è¦æ˜¯ä¸­é—´æœ‰ä¸€æ®µæ—¶é—´ç”µè„‘åäº†ï¼Œæ‰“ä¹±äº†èŠ‚å¥ï¼Œå°±ä¸€æ‹–å†æ‹–ã€‚

V2Ray æ˜¯ä¸€æ¬¾æˆ‘å¾ˆå–œæ¬¢çš„è½¯ä»¶ï¼Œé¦–å…ˆå®ƒå¹¶ä¸åªæ˜¯ç”¨æ¥ç¿»å¢™çš„ï¼Œæ­£å‘ä»£ç†ã€åå‘ä»£ç†ã€é€æ˜ä»£ç†ã€DNS æœåŠ¡å™¨ã€å¹¿å‘Šè¿‡æ»¤å®ƒéƒ½å¯ä»¥èƒœä»»ã€‚

> Project V æ˜¯ä¸€ä¸ªå·¥å…·é›†åˆï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ æ‰“é€ ä¸“å±çš„åŸºç¡€é€šä¿¡ç½‘ç»œã€‚Project V çš„æ ¸å¿ƒå·¥å…·ç§°ä¸º `V2Ray`ï¼Œå…¶ä¸»è¦è´Ÿè´£ç½‘ç»œåè®®å’ŒåŠŸèƒ½çš„å®ç°ï¼Œä¸å…¶å®ƒ Project V é€šä¿¡ã€‚V2Ray å¯ä»¥å•ç‹¬è¿è¡Œï¼Œä¹Ÿå¯ä»¥å’Œå…¶å®ƒå·¥å…·é…åˆï¼Œä»¥æä¾›ç®€ä¾¿çš„æ“ä½œæµç¨‹ã€‚

æ˜¯çš„ï¼Œè¯·ä¸è¦å¿˜è®°å®ƒçš„é›„å¿ƒå£®å¿—ï¼ŒV2Ray åªæ˜¯ä¸€ä¸ªæ ¸å¿ƒï¼Œä½†ä¸æ˜¯å…¨éƒ¨ã€‚

æˆ‘æ—¶å¸¸ç€è¿·äº V2Ray çš„æ¨¡å—ç»„åˆï¼Œæ¯ä¸€ä¸ªåè®®å’Œä¼ è¾“å¹¶ä¸å¤æ‚ï¼Œä½†ç»„åˆèµ·æ¥å´æ˜¯åƒå˜ä¸‡åŒ–ï¼Œå¸¦æ¥æ— é™çš„å¯èƒ½æ€§ã€‚å°±åƒæ•°å­¦ä¸­çš„ä¸€ä¸ªä¸ªå˜é‡ï¼Œç»„åˆèµ·æ¥å°±ä¼šå˜æˆå¤æ‚çš„å‡½æ•°ã€‚

V2Ray çš„ç¤¾åŒºæ°›å›´å¾ˆå¥½ï¼Œæ¯å¤©ä¸æ–­çš„æœ‰ issue è¢«æå‡ºï¼ŒåŒæ—¶åˆæœ‰äººæäº¤ PRï¼Œæœ€ååˆå¹¶å…¥ä¸»çº¿ã€‚V2Ray ç‰ˆæœ¬è¿­ä»£çš„é€Ÿåº¦å¾ˆå¿«ï¼Œä¸é•¿æ—¶é—´å°±ä¼šå‡ºç°æ–°çš„åŠŸèƒ½ã€‚å°¤å…¶æ˜¯ä» V2Ray è¢«å‘ç°å¤šä¸ªå¤§æ¼æ´äº‹ä»¶å¼€å§‹ï¼Œå‡ ä¸ªæœˆçš„æ—¶é—´ï¼Œä¸€ä¸ªæ–°çš„åè®®å·²ç»è¢«å¼€å‘å‡ºæ¥ã€‚

VLESSï¼Œä¸€ä¸ªæ‡‚å¾—åšå‡æ³•çš„åè®®ï¼Œè½»é‡è€ŒåˆåŠŸèƒ½ä¸°å¯Œï¼Œè²Œä¼¼å¯¹ UDP è¿˜è¿›è¡Œäº†ä¸€å®šçš„ä¼˜åŒ–ã€‚

è¿˜æœ‰ä¸€ä¸ªå…³äºä¸Šæ–‡çš„æ–¹æ¡ˆä¸­æ²¡æœ‰æåˆ°çš„ V2Ray åˆ†æµçš„é—®é¢˜ã€‚ç”±äºå¾ˆå¤§ä¸€éƒ¨åˆ†åœ°å€åœ¨è¿›å…¥ V2Ray ä¹‹å‰å°±è¢« Netfilter åˆ†æµç›´æ¥å‡ºå»ï¼Œæ‰€ä»¥ V2Ray è·¯ç”±æ¨¡å—ä¸­è½¬å¾€ Blackhole çš„æµé‡å¦‚å¹¿å‘Šè¿‡æ»¤åŠŸèƒ½å¤±æ•ˆã€‚çœ‹æ¥å°† V2Ray çš„ä¸€éƒ¨åˆ†åŠŸèƒ½åˆ†æ‹…å‡ºå»å°±ä¼šå¯¼è‡´è¿é”ååº”ã€‚

è¯´æ˜¯å¤§åŠå¹´ï¼Œå…¶å®å·²ç»å¿«ä¸€å¹´äº†ï¼Œæˆ‘çš„è‡ªæˆ‘å­¦ä¹ è¿‡ç¨‹å¾€å¾€éƒ½ä»¥å®è·µä¸ºä¸»ï¼Œå…ˆåšå†å­¦ä¹ åŸç†ï¼Œåœ¨æŸç§åŠ¨æœºçš„é©±ä½¿ä¸‹ï¼ŒæŸ¥æ‰¾å„ç§èµ„æ–™å¹¶è¿›è¡Œæµ‹è¯•ï¼Œæœ‰æ—¶è¿˜éœ€è¦å†¥æ€è‹¦æƒ³ï¼Œåœ¨è¿™æ ·ä¸€ä¸ªè‰°éš¾çš„è¿‡ç¨‹ä¸­ï¼Œä¸æ–­æ”¶è·ç€å„ç§çŸ¥è¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯æˆ‘å¾ˆäº«å—çš„ã€‚è™½ç„¶å¦‚æ­¤ï¼Œä½†æœ‰æ—¶ä¹Ÿæ˜¯è¢«é€¼æ— å¥ˆï¼Œå¦‚æœä¸æ˜¯èº«å¤„ç‰¹æ®Šçš„ç¯å¢ƒä¸‹ï¼Œæ€ä¹ˆåˆä¼šæœ‰ç ”ç©¶çš„åŠ¨æœºå‘¢ï¼Ÿ

åœ¨æ­¤æƒ³è¦æ„Ÿè°¢å¾ˆå¤šäººï¼Œé™¤äº†ä¸‹é¢æ’°å†™å‚è€ƒå’Œå¼•ç”¨ä¸­é‚£äº›æ–‡ç« çš„äººï¼Œä¹Ÿè¦æ„Ÿè°¢æ‰€æœ‰ä¸ºè¿™ä¸€åˆ‡åšå‡ºè´¡çŒ®çš„äººã€‚æ²¡æœ‰ä½ ä»¬çš„ä»˜å‡ºï¼Œä¹Ÿä¸ä¼šæœ‰æˆ‘è¿™ç¯‡æ–‡ç« ã€‚

è‡³æ­¤ï¼Œæœ¬æ–¹æ¡ˆä½¿ç”¨ä½“éªŒååˆ†è‰¯å¥½ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šæƒ…å†µï¼Œå›´ç»•ç€ V2Ray å±•å¼€çš„å„ç§è®¡ç®—æœºç½‘ç»œè¯é¢˜å°±è¦å‘Šä¸€æ®µè½äº†ã€‚å°½è¯·æœŸå¾…æ›´å¤šç²¾å½©å†…å®¹ï¼

## å‚è€ƒ

1. [æ¼«è°ˆå„ç§é»‘ç§‘æŠ€å¼ DNS æŠ€æœ¯åœ¨ä»£ç†ç¯å¢ƒä¸­çš„åº”ç”¨ | by Tachyon | Medium](https://medium.com/@TachyonDevel/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0)

2. [DNSåŠå…¶åº”ç”¨ â€” Steemit](https://steemit.com/cn/@v2ray/dns)

3. [å…³äºåœ¨é…ç½® V2Ray åš DNS æœåŠ¡å™¨è¿‡ç¨‹ä¸­å¼•å‡ºçš„é—®é¢˜ Â· Issue #751 Â· v2ray/discussion](https://github.com/v2ray/discussion/issues/751)

4. [Report for ' failed to bind source address > address already in use' when using tproxy Â· Issue #68 Â· v2fly/v2ray-core](https://github.com/v2fly/v2ray-core/issues/68)

5. [DNS æœåŠ¡å™¨ | V2Fly.org](https://www.v2fly.org/config/dns.html)

6. [å¦‚ä½•é€‰æ‹©é€‚åˆçš„å…¬å…± DNSï¼Ÿ \[2020\] | Sukka's Blog](https://blog.skk.moe/post/which-public-dns-to-use/)

7. [VMess | æ–° V2Ray ç™½è¯æ–‡æŒ‡å—](https://guide.v2fly.org/basics/vmess.html)

8. [å¯¹äºæ‰€è°“â€œæ—è·¯ç”±â€çš„ç–‘æƒ‘ - V2EX](https://www.v2ex.com/t/663066)

9. [é€æ˜ä»£ç† UDP ä¸ºä»€ä¹ˆè¦ç”¨ TProxyï¼Ÿ - ç®€ä¹¦](https://www.jianshu.com/p/5393fb5e2c87)

10. [V2RAYé€æ˜ä»£ç† | xdays](https://xdays.me/V2RAY%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/)

11. [æ­å»ºç½‘å…³ç³»åˆ— â€”â€” è·¯ç”±ç¯‡](https://onebitbug.me/2014/06/03/building-a-gateway-route/)

12. [TProxy - The Linux Kernel Archives](https://www.kernel.org/doc/Documentation/networking/tproxy.txt)

13. [Linuxä½¿ç”¨TPROXYè¿›è¡ŒUDPçš„é€æ˜ä»£ç† - ç®€ä¹¦](https://www.jianshu.com/p/76cea3ef249d)

14. [Internet sharing - ArchWiki](https://wiki.archlinux.org/index.php/Internet_sharing)

15. [nftables - ArchWiki](https://wiki.archlinux.org/index.php/Nftables)

16. [nft(8) â€” Arch manual pages](https://jlk.fjfi.cvut.cz/arch/manpages/man/nft.8)

17. [Sets - nftables wiki](https://wiki.nftables.org/wiki-nftables/index.php/Sets)

18. [Moving from iptables to nftables - nftables wiki](https://wiki.nftables.org/wiki-nftables/index.php/Moving_from_iptables_to_nftables)

19. [Moving from ipset to nftables - nftables wiki](https://wiki.nftables.org/wiki-nftables/index.php/Moving_from_ipset_to_nftables)

20. [nftablesåˆä½“éªŒ|I'm OWenT](https://owent.net/2020/2002.html)

21. [åŒ…çš„è·¯ç”±è½¬åœˆåœˆâ€”â€”è°ˆè°ˆä½¿ç”¨nftablesé…ç½®é€æ˜ä»£ç†ç¢°åˆ°çš„é‚£äº›å‘ | KosWu 's blog](https://koswu.github.io/2019/08/19/tproxy-config-with-nftables/)

22. [ã€Linuxã€‘vimåœ¨æ¯è¡Œè¡Œé¦–æˆ–è¡Œå°¾æ·»åŠ /åˆ é™¤å†…å®¹_å­éé±¼çš„åšå®¢-CSDNåšå®¢_ubuntu viç¼–è¾‘å™¨åˆ é™¤æ¯è¡Œå¼€å¤´](https://blog.csdn.net/wangchao7281/article/details/53318670)

12. [TProxyå¯¦ç¾é€æ˜ä»£ç† - å°å­¸éœ¸](https://xuebaxi.com/blog/2019-11-23-01)

13. [ä½¿ç”¨ iptablesã€ipset çš„å…¨å±€æ™ºèƒ½ä»£ç† | chih's blog](https://blog.chih.me/global-proxy-within-ipset-and-iptables.html)

14. [V2Ray é€æ˜ä»£ç†å’ŒZoomä¼˜åŒ–](https://youth2009.org/v2ray-transparent-proxy-and-zoom-udp-optimization/)

15. [Dokodemo UDPè½¬å‘å¯¼è‡´æ–­æµ Â· Issue #1432 Â· v2ray/v2ray-core](https://github.com/v2ray/v2ray-core/issues/1432)

27. [å¦‚ä½•æ›´æ”¹ IPv6 è·¯ç”±é€šå‘Šä¸‹å‘çš„é»˜è®¤è·¯ç”±ç½‘å…³é…ç½® - V2EX](https://www.v2ex.com/t/685344)

28. [Project V Â· Project V å®˜æ–¹ç½‘ç«™](https://www.v2ray.com/)

29. [V2Ray é…ç½®æŒ‡å—|V2Ray ç™½è¯æ–‡æ•™ç¨‹](https://toutyrater.github.io/)

30. [V2Fly.org](https://www.v2fly.org/)

31. [V2Ray é…ç½®æŒ‡å— | æ–° V2Ray ç™½è¯æ–‡æŒ‡å—](https://guide.v2fly.org/)

32. [V2Rayå®Œå…¨é…ç½®æŒ‡å— â€“ Ai](https://ailitonia.com/archives/v2rayå®Œå…¨é…ç½®æŒ‡å—/)

## å¼•ç”¨

[^1]: [Dokodemo-door | V2Fly.org](https://www.v2fly.org/config/protocols/dokodemo.html)

[^2]: [DNS | V2Fly.org](https://www.v2fly.org/config/protocols/dns.html)

[^3]: [ä½¿ç”¨å…¬å…± DNS ä¸Šç½‘çš„å¼Šç«¯ï¼ˆäºŒï¼‰ | Ephenâ€˜s Blog](https://ephen.me/2017/PublicDns_2/)

[^4]: [å“ªé‡Œæœ‰cnip.txtæ–‡ä»¶ï¼Ÿ Â· Issue #2 Â· wolf-joe/ts-dns](https://github.com/wolf-joe/ts-dns/issues/2)

[^5]: [Inbounds | V2Fly.org](https://www.v2fly.org/config/inbounds.html)

[^6]: [Netfilter - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦](https://zh.wikipedia.org/wiki/Netfilter)

[^7]: [ç¬¬ 2 ç«  Debian 10 çš„æ–°å˜åŒ–](https://www.debian.org/releases/stable/mips/release-notes/ch-whats-new.zh-cn.html#nftables)

[^8]: [Jan Engelhardt / CC BY-SA (https://creativecommons.org/licenses/by-sa/3.0)](https://commons.wikimedia.org/wiki/File:Netfilter-packet-flow.svg)

[^9]: [å¯¹äºæ‰€è°“â€œæ—è·¯ç”±â€çš„ç–‘æƒ‘ - V2EX](https://www.v2ex.com/t/663066)

[^10]: [å¤šæ–‡ä»¶é…ç½® | V2Fly.org](https://www.v2fly.org/config/multiple_config.html)